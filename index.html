<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Store Products</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 2rem;
        background-color: #fafafa;
        color: #202124;
      }

      h1 {
        margin-bottom: 1rem;
      }

      p.description {
        margin-bottom: 1.5rem;
        color: #5f6368;
      }

      ul {
        list-style: disc;
        padding-left: 1.5rem;
      }

      li {
        margin-bottom: 1rem;
      }

      li img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 8px;
        margin-right: 0.75rem;
        vertical-align: middle;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      }

      li a {
        font-weight: 600;
        color: #1a73e8;
        text-decoration: none;
        vertical-align: middle;
      }

      li a:hover {
        text-decoration: underline;
      }

      #status-message {
        color: #5f6368;
      }
    </style>
  </head>
  <body>
    <h1>Store products</h1>
    <p class="description">
      Products retrieved from the MonittaStore API endpoint.
    </p>
    <p id="status-message">Loading productsâ€¦</p>
    <ul id="items-list"></ul>

    <script>
      const API_URL = "https://localhost:7193/MonittaStore";
      const listElement = document.getElementById("items-list");
      const statusElement = document.getElementById("status-message");

      function normaliseProducts(payload) {
        if (!payload) {
          return [];
        }

        if (Array.isArray(payload)) {
          return payload;
        }

        const possibleCollections = ["items", "products", "data", "results"];
        for (const key of possibleCollections) {
          if (Array.isArray(payload[key])) {
            return payload[key];
          }
        }

        return [];
      }

      function resolveImageUrl(product) {
        return (
          product?.imageUrl ||
          product?.image ||
          product?.thumbnail ||
          product?.photo?.url ||
          product?.photos?.[0]?.url ||
          undefined
        );
      }

      function resolveLink(product) {
        return (
          product?.url ||
          product?.link ||
          product?.href ||
          product?.permalink ||
          ""
        );
      }

      function resolveTitle(product, index) {
        return (
          product?.title ||
          product?.name ||
          product?.description ||
          product?.id?.toString?.() ||
          `Product #${index + 1}`
        );
      }

      async function loadProducts() {
        try {
          const response = await fetch(API_URL, {
            headers: {
              accept: "application/json",
            },
          });

          if (!response.ok) {
            throw new Error(`Request failed with status ${response.status}`);
          }

          const payload = await response.json();
          const products = normaliseProducts(payload);

          if (!Array.isArray(products) || products.length === 0) {
            statusElement.textContent = "No products found.";
            statusElement.style.display = "block";
            return;
          }

          statusElement.textContent = "";
          statusElement.style.display = "none";

          products.forEach((product, index) => {
            const listItem = document.createElement("li");

            const imageUrl = resolveImageUrl(product);
            if (imageUrl) {
              const image = document.createElement("img");
              image.src = imageUrl;
              image.alt = resolveTitle(product, index);
              listItem.appendChild(image);
            }

            const linkUrl = resolveLink(product);
            const title = resolveTitle(product, index);

            if (linkUrl) {
              const link = document.createElement("a");
              link.href = linkUrl;
              link.target = "_blank";
              link.rel = "noopener noreferrer";
              link.textContent = title;
              listItem.appendChild(link);
            } else {
              const text = document.createElement("span");
              text.textContent = title;
              listItem.appendChild(text);
            }

            listElement.appendChild(listItem);
          });
        } catch (error) {
          console.error("Unable to load products", error);
          statusElement.textContent = "Unable to load products. Please try again later.";
          statusElement.style.display = "block";
        }
      }

      loadProducts();
    </script>
  </body>
</html>
