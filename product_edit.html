<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Edycja produktu</title>
    <style>
      :root {
        color-scheme: light;
        font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      }

      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: stretch;
        justify-content: center;
        background: linear-gradient(145deg, #f7f7f7, #e9ecf1);
        padding: 2rem 1rem 3rem;
      }

      main {
        width: min(960px, 100%);
        margin: 0 auto;
        background: #ffffff;
        border-radius: 24px;
        padding: clamp(1.75rem, 2vw + 1rem, 2.75rem) clamp(1.5rem, 2vw + 0.75rem, 3rem);
        box-shadow: 0 20px 55px rgba(15, 23, 42, 0.12);
        display: flex;
        flex-direction: column;
        gap: 2rem;
      }

      .top-actions {
        display: flex;
        justify-content: flex-start;
      }

      .back-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1.15rem;
        border-radius: 999px;
        background: rgba(99, 102, 241, 0.12);
        color: #4338ca;
        font-weight: 600;
        text-decoration: none;
        transition: background 0.2s ease, color 0.2s ease, transform 0.2s ease;
      }

      .back-link:hover,
      .back-link:focus {
        background: rgba(99, 102, 241, 0.2);
        color: #312e81;
        transform: translateY(-1px);
        outline: none;
      }

      header {
        text-align: center;
      }

      h1 {
        margin: 0;
        font-size: clamp(1.85rem, 2.2vw + 1.2rem, 2.6rem);
        color: #1f2937;
      }

      .subtitle {
        margin-top: 0.5rem;
        color: #4b5563;
        font-size: 1rem;
      }

      #status {
        margin: 0;
        padding: 1rem 1.25rem;
        border-radius: 14px;
        border: 1px solid rgba(99, 102, 241, 0.25);
        background: rgba(99, 102, 241, 0.06);
        color: #312e81;
        line-height: 1.5;
        transition: background 0.3s ease, border-color 0.3s ease, color 0.3s ease;
      }

      #status[data-status-type="error"] {
        border-color: rgba(239, 68, 68, 0.35);
        background: rgba(254, 226, 226, 0.65);
        color: #991b1b;
      }

      #status[data-status-type="success"] {
        border-color: rgba(16, 185, 129, 0.35);
        background: rgba(209, 250, 229, 0.7);
        color: #065f46;
      }

      form {
        display: grid;
        gap: 1.5rem;
      }

      fieldset {
        border: 1px solid #e5e7eb;
        border-radius: 18px;
        padding: 1.25rem 1.5rem 1.5rem;
        background: #f9fafb;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      legend {
        font-weight: 600;
        color: #1f2937;
        padding: 0 0.5rem;
      }

      .field {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      label {
        font-weight: 600;
        color: #111827;
      }

      input[type="text"],
      input[type="search"],
      textarea {
        width: 100%;
        border-radius: 12px;
        border: 1px solid #d1d5db;
        padding: 0.85rem 1rem;
        font: inherit;
        color: #1f2937;
        background-color: #ffffff;
        transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
      }

      input[type="file"] {
        font: inherit;
      }

      .file-input {
        width: 100%;
        border-radius: 12px;
        border: 1px dashed #c7d2fe;
        padding: 0.75rem 1rem;
        background-color: #eef2ff;
        color: #312e81;
        transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
      }

      .file-input:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.12);
        background-color: #e0e7ff;
      }

      .file-input::file-selector-button {
        border: none;
        border-radius: 999px;
        padding: 0.5rem 1.25rem;
        margin-right: 0.75rem;
        font: inherit;
        font-weight: 600;
        background: linear-gradient(120deg, #6366f1, #8b5cf6);
        color: #ffffff;
        cursor: pointer;
        transition: filter 0.2s ease, transform 0.2s ease;
      }

      .file-input::file-selector-button:hover,
      .file-input::file-selector-button:focus {
        filter: brightness(1.05);
        transform: translateY(-1px);
      }

      .hint {
        margin: 0;
        color: #6b7280;
        font-size: 0.875rem;
      }

      input[readonly],
      textarea[readonly] {
        background-color: #f3f4f6;
        color: #374151;
      }

      textarea {
        min-height: 160px;
        resize: vertical;
      }

      .image-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 1rem;
      }

      .image-grid figure {
        margin: 0;
        background: #ffffff;
        border-radius: 16px;
        padding: 0.75rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
      }

      .image-grid img {
        width: 100%;
        aspect-ratio: 1 / 1;
        object-fit: cover;
        border-radius: 12px;
        background-color: #e5e7eb;
      }

      .image-grid figcaption {
        font-size: 0.875rem;
        color: #4b5563;
        text-align: center;
      }

      .upload-preview {
        margin-top: 0.75rem;
      }

      .upload-preview figure {
        box-shadow: 0 8px 18px rgba(79, 70, 229, 0.12);
      }

      .upload-preview figcaption {
        color: #4338ca;
      }

      .form-actions {
        display: flex;
        justify-content: flex-end;
        padding-top: 0.5rem;
      }

      .form-actions button {
        border: none;
        border-radius: 999px;
        padding: 0.9rem 2.75rem;
        font-weight: 600;
        font-size: 1rem;
        background: linear-gradient(120deg, #6366f1, #8b5cf6);
        color: #ffffff;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.2s ease, filter 0.2s ease;
      }

      .form-actions button:hover,
      .form-actions button:focus {
        transform: translateY(-1px);
        box-shadow: 0 14px 28px rgba(99, 102, 241, 0.25);
        outline: none;
      }

      .form-actions button:active {
        transform: translateY(1px);
        box-shadow: 0 8px 18px rgba(99, 102, 241, 0.25);
      }

      .form-actions button[disabled] {
        cursor: not-allowed;
        opacity: 0.7;
        box-shadow: none;
        transform: none;
      }

      .placeholder {
        color: #6b7280;
        font-style: italic;
      }

      .monitta-controls {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .monitta-search {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
      }

      .monitta-search__label {
        font-weight: 600;
        color: #111827;
        font-size: 0.95rem;
      }

      .monitta-count {
        font-size: 0.9rem;
        color: #4b5563;
      }

      .monitta-status {
        margin: 0;
        padding: 0.75rem 1rem;
        border-radius: 12px;
        border: 1px solid rgba(99, 102, 241, 0.25);
        background: rgba(99, 102, 241, 0.08);
        color: #312e81;
        font-size: 0.95rem;
      }

      .monitta-status[data-status-type="error"] {
        border-color: rgba(239, 68, 68, 0.35);
        background: rgba(254, 226, 226, 0.82);
        color: #991b1b;
      }

      .monitta-status[data-status-type="success"] {
        border-color: rgba(16, 185, 129, 0.35);
        background: rgba(209, 250, 229, 0.7);
        color: #065f46;
      }

      .monitta-options {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        gap: 0.75rem;
      }

      .monitta-option {
        background: #ffffff;
        border-radius: 16px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 8px 18px rgba(99, 102, 241, 0.07);
        padding: 0.75rem 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .monitta-option__label {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        cursor: pointer;
      }

      .monitta-option__label input[type="checkbox"] {
        margin-top: 0.2rem;
      }

      .monitta-option__content {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .monitta-option__title {
        font-weight: 600;
        color: #1f2937;
      }

      .monitta-option__meta {
        font-size: 0.875rem;
        color: #4b5563;
      }

      .monitta-option__description {
        font-size: 0.85rem;
        color: #6b7280;
      }

      .monitta-option__link {
        align-self: flex-start;
        font-size: 0.85rem;
        font-weight: 600;
        color: #2563eb;
        text-decoration: none;
      }

      .monitta-option__link:hover,
      .monitta-option__link:focus {
        text-decoration: underline;
      }

      .monitta-selected {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .monitta-selected-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .monitta-selected-item {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        border-radius: 16px;
        background: #eef2ff;
        border: 1px solid #c7d2fe;
      }

      .monitta-selected-content {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        min-width: 0;
        flex: 1 1 220px;
      }

      .monitta-selected-title {
        font-weight: 600;
        color: #1f2937;
      }

      .monitta-selected-meta {
        font-size: 0.85rem;
        color: #4b5563;
      }

      .monitta-selected-actions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
      }

      .monitta-selected-link {
        padding: 0.35rem 0.9rem;
        border-radius: 999px;
        background: rgba(99, 102, 241, 0.12);
        color: #4338ca;
        text-decoration: none;
        font-weight: 600;
        font-size: 0.85rem;
      }

      .monitta-selected-link:hover,
      .monitta-selected-link:focus {
        background: rgba(99, 102, 241, 0.18);
        outline: none;
      }

      .monitta-remove {
        border: none;
        border-radius: 999px;
        padding: 0.35rem 0.9rem;
        background: linear-gradient(120deg, #6366f1, #8b5cf6);
        color: #ffffff;
        font-weight: 600;
        font-size: 0.85rem;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.2s ease, filter 0.2s ease;
      }

      .monitta-remove:hover,
      .monitta-remove:focus {
        filter: brightness(1.05);
        outline: none;
        box-shadow: 0 10px 18px rgba(99, 102, 241, 0.2);
      }

      .monitta-remove:active {
        transform: translateY(1px);
      }

      @media (min-width: 720px) {
        .monitta-controls {
          flex-direction: row;
          align-items: flex-end;
          justify-content: space-between;
        }

        .monitta-search {
          flex: 1 1 auto;
        }

        .monitta-count {
          text-align: right;
        }

        .monitta-selected-actions {
          justify-content: flex-end;
        }
      }

      .vintage-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .vintage-item {
        background: #ffffff;
        border-radius: 16px;
        padding: 0.85rem 1rem;
        border: 1px solid #e5e7eb;
        box-shadow: 0 8px 18px rgba(15, 23, 42, 0.05);
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
      }

      .vintage-item a {
        color: #2563eb;
        font-weight: 600;
        text-decoration: none;
      }

      .vintage-item a:hover,
      .vintage-item a:focus {
        text-decoration: underline;
      }

      .vintage-item small {
        color: #6b7280;
      }

      pre {
        margin: 0;
        padding: 1rem;
        background: #0f172a;
        color: #e0f2fe;
        border-radius: 14px;
        max-height: 360px;
        overflow: auto;
        font-size: 0.875rem;
      }

      @media (max-width: 720px) {
        body {
          padding: 1.5rem 0.75rem 2rem;
        }

        main {
          border-radius: 18px;
          padding: 1.75rem 1.25rem 2rem;
        }

        fieldset {
          padding: 1rem 1rem 1.25rem;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <div class="top-actions">
        <a class="back-link" href="products.html">← Powrót do listy produktów</a>
      </div>
      <header>
        <h1>Edycja produktu</h1>
        <p class="subtitle">
          Wczytaj szczegóły istniejącej stylizacji, korzystając z identyfikatora produktu.
        </p>
      </header>
      <p id="status" role="status" aria-live="polite"></p>
      <form id="product-form" hidden novalidate>
        <fieldset>
          <legend>Podstawowe informacje</legend>
          <div class="field">
            <label for="product-id">Identyfikator produktu</label>
            <input type="text" id="product-id" name="product-id" readonly />
          </div>
          <div class="field">
            <label for="product-name">Nazwa stylizacji</label>
            <input type="text" id="product-name" name="product-name" />
          </div>
          <div class="field">
            <label for="product-description">Opis</label>
            <textarea id="product-description" name="product-description"></textarea>
          </div>
        </fieldset>

        <fieldset>
          <legend>Zdjęcia produktu</legend>
          <div id="product-images" class="image-grid">
            <p class="placeholder">Brak zdjęć do wyświetlenia.</p>
          </div>
          <div class="field">
            <label for="new-images">Dodaj nowe zdjęcia</label>
            <input
              type="file"
              id="new-images"
              name="new-images"
              class="file-input"
              accept="image/*"
              multiple
            />
            <p class="hint">Możesz wybrać kilka plików graficznych (PNG, JPG, WebP) jednocześnie.</p>
            <div
              id="new-images-preview"
              class="image-grid upload-preview"
              aria-live="polite"
              aria-busy="false"
            >
              <p class="placeholder">Nie wybrano jeszcze nowych zdjęć.</p>
            </div>
          </div>
        </fieldset>

        <fieldset>
          <legend>Produkty vintage</legend>
          <ul id="vintage-products" class="vintage-list">
            <li class="placeholder">Brak powiązanych produktów vintage.</li>
          </ul>
        </fieldset>

        <fieldset>
          <legend>Produkty MonittaStore</legend>
          <p class="hint">
            Wybierz produkty Monitta Store, które chcesz powiązać z tą stylizacją.
          </p>
          <div class="monitta-controls">
            <label class="monitta-search" for="monitta-store-search">
              <span class="monitta-search__label">Wyszukaj produkt</span>
              <input
                type="search"
                id="monitta-store-search"
                name="monitta-store-search"
                placeholder="Filtruj po nazwie, identyfikatorze lub rozmiarze"
                autocomplete="off"
              />
            </label>
            <span class="monitta-count" id="monitta-store-count" aria-live="polite">Wybrano: 0</span>
          </div>
          <p class="monitta-status" id="monitta-store-status" role="status">
            Trwa przygotowywanie listy produktów Monitta Store…
          </p>
          <ul
            id="monitta-store-list"
            class="monitta-options"
            aria-live="polite"
            aria-busy="true"
          >
            <li class="placeholder">Lista produktów jest wczytywana…</li>
          </ul>
          <div class="monitta-selected" id="monitta-store-selected">
            <p class="placeholder">Nie wybrano produktów Monitta Store.</p>
          </div>
        </fieldset>

        <fieldset>
          <legend>Surowe dane z interfejsu API</legend>
          <pre id="raw-json">Ładowanie…</pre>
        </fieldset>

        <div class="form-actions">
          <button type="button" id="save-button">Zapisz</button>
        </div>
      </form>
    </main>
    <script>
      (function () {
        const statusElement = document.getElementById("status");
        const form = document.getElementById("product-form");
        const idInput = document.getElementById("product-id");
        const nameInput = document.getElementById("product-name");
        const descriptionInput = document.getElementById("product-description");
        const imagesContainer = document.getElementById("product-images");
        const newImagesInput = document.getElementById("new-images");
        const newImagesPreview = document.getElementById("new-images-preview");
        const vintageList = document.getElementById("vintage-products");
        const monittaStatusElement = document.getElementById("monitta-store-status");
        const monittaListElement = document.getElementById("monitta-store-list");
        const monittaSelectedElement = document.getElementById("monitta-store-selected");
        const monittaSearchInput = document.getElementById("monitta-store-search");
        const monittaCountElement = document.getElementById("monitta-store-count");
        const rawJson = document.getElementById("raw-json");
        const saveButton = document.getElementById("save-button");

        const apiBaseUrl =
          "https://vintagecrawlerappservice-hqb0f5bmfrdwf0g7.polandcentral-01.azurewebsites.net/products";
        const uploadBaseUrl =
          "https://vintagecrawlerappservice-hqb0f5bmfrdwf0g7.polandcentral-01.azurewebsites.net/upload";
        const monittaEndpoint =
          "https://vintagecrawlerappservice-hqb0f5bmfrdwf0g7.polandcentral-01.azurewebsites.net/MonittaStore";

        const monittaState = {
          isLoading: true,
          filter: "",
          allProducts: [],
          allProductsMap: new Map(),
          selectedMap: new Map(),
          error: null,
        };

        const params = new URLSearchParams(window.location.search);
        const productId = params.get("productID") ?? params.get("id");

        let currentProduct = null;
        let isSaving = false;

        const defaultSaveLabel =
          saveButton && typeof saveButton.textContent === "string"
            ? saveButton.textContent.trim() || "Zapisz"
            : "Zapisz";
        const savingLabel = "Zapisywanie…";

        const hasProductData = (product) =>
          !!(product && typeof product === "object" && Object.keys(product).length > 0);

        const updateSaveButtonState = () => {
          if (!saveButton) {
            return;
          }

          const shouldDisable = isSaving || !hasProductData(currentProduct);
          saveButton.disabled = shouldDisable;
          saveButton.textContent = isSaving ? savingLabel : defaultSaveLabel;
        };

        const setSavingState = (saving) => {
          isSaving = saving;

          if (saveButton) {
            saveButton.setAttribute("aria-busy", saving ? "true" : "false");
          }

          updateSaveButtonState();
        };

        updateSaveButtonState();

        const setStatus = (message, type = "info") => {
          if (!statusElement) {
            return;
          }

          statusElement.textContent = message;
          if (type === "info") {
            delete statusElement.dataset.statusType;
          } else {
            statusElement.dataset.statusType = type;
          }
          statusElement.hidden = false;
        };

        const toArray = (value) => {
          if (Array.isArray(value)) {
            return value;
          }

          if (!value) {
            return [];
          }

          if (typeof value === "object") {
            if (Array.isArray(value.items)) {
              return value.items;
            }
            if (Array.isArray(value.data)) {
              return value.data;
            }
            if (Array.isArray(value.products)) {
              return value.products;
            }
            if (Array.isArray(value.results)) {
              return value.results;
            }
            if (Array.isArray(value.entries)) {
              return value.entries;
            }
          }

          return [];
        };

        const resolveField = (source, candidates, fallback = "") => {
          if (typeof source !== "object" || source === null) {
            return fallback;
          }

          for (const key of candidates) {
            if (key in source && source[key] != null && source[key] !== "") {
              return source[key];
            }
          }

          return fallback;
        };

        const toDisplayString = (value) => {
          if (value == null) {
            return "";
          }

          if (typeof value === "string") {
            return value;
          }

          if (typeof value === "number" || typeof value === "bigint") {
            return String(value);
          }

          if (typeof value === "boolean") {
            return value ? "true" : "false";
          }

          return String(value);
        };

        const formatMonittaPrice = (product) => {
          if (!product || typeof product !== "object") {
            return "";
          }

          const priceSources = [
            product.price,
            product.total_item_price,
            product.totalItemPrice,
            product.total_price,
            product.totalPrice,
          ];

          for (const source of priceSources) {
            if (!source || typeof source !== "object") {
              continue;
            }

            const amountValue = resolveField(source, ["amount", "value"]);
            if (amountValue == null || amountValue === "") {
              continue;
            }

            const amountText = toDisplayString(amountValue).trim();
            if (!amountText) {
              continue;
            }

            const currencyValue =
              resolveField(source, ["currency_code", "currency", "currencyCode"]) ||
              resolveField(product, ["currency", "currency_code", "currencyCode", "priceCurrency"]);

            if (currencyValue != null && currencyValue !== "") {
              const currencyText = toDisplayString(currencyValue).trim();
              return currencyText ? `${amountText} ${currencyText}` : amountText;
            }

            return amountText;
          }

          const directAmount =
            product.price ?? product.amount ?? product.value ?? product.price_amount ?? product.priceValue;

          if (typeof directAmount === "number" || typeof directAmount === "string") {
            const amountText = toDisplayString(directAmount).trim();
            if (amountText) {
              const currencyValue = resolveField(product, [
                "currency",
                "currency_code",
                "currencyCode",
                "priceCurrency",
              ]);
              if (currencyValue != null && currencyValue !== "") {
                const currencyText = toDisplayString(currencyValue).trim();
                return currencyText ? `${amountText} ${currencyText}` : amountText;
              }
              return amountText;
            }
          }

          return "";
        };

        const getMonittaIdentifier = (source) => {
          if (source == null) {
            return "";
          }

          if (typeof source === "object" && !Array.isArray(source)) {
            let identifier = resolveField(source, [
              "id",
              "Id",
              "ID",
              "productId",
              "productID",
              "item_id",
              "itemId",
              "listingId",
              "listing_id",
              "VintageProductId",
              "vintageProductId",
            ]);

            if (identifier && typeof identifier === "object") {
              const nested = resolveField(identifier, ["id", "value"]);
              if (nested != null && nested !== "") {
                identifier = nested;
              }
            }

            if (identifier != null && identifier !== "") {
              const text = toDisplayString(identifier).trim();
              if (text) {
                return text;
              }
            }

            const fallback =
              resolveField(source, ["path", "slug"]) ||
              resolveField(source, [
                "VintageProductUrl",
                "vintageProductUrl",
                "url",
                "link",
                "productUrl",
                "href",
              ]);

            if (fallback != null && fallback !== "") {
              const text = toDisplayString(fallback).trim();
              if (text) {
                return text;
              }
            }

            return "";
          }

          return toDisplayString(source).trim();
        };

        const createMonittaEntry = (product) => {
          if (product == null) {
            return null;
          }

          const identifier = getMonittaIdentifier(product);
          if (!identifier) {
            return null;
          }

          const raw =
            typeof product === "object" && product !== null ? product : { id: identifier };

          const titleCandidate =
            typeof product === "object" && product !== null
              ? resolveField(product, [
                  "title",
                  "name",
                  "productName",
                  "label",
                  "VintageProductName",
                  "vintageProductName",
                ])
              : null;
          const title =
            titleCandidate && toDisplayString(titleCandidate).trim()
              ? toDisplayString(titleCandidate).trim()
              : `Produkt Monitta ${identifier}`;

          const priceText =
            typeof product === "object" && product !== null ? formatMonittaPrice(product) : "";

          const descriptionCandidate =
            typeof product === "object" && product !== null
              ? resolveField(product, ["description", "summary", "details"])
              : "";
          const description =
            descriptionCandidate && toDisplayString(descriptionCandidate).trim()
              ? toDisplayString(descriptionCandidate).trim()
              : "";

          const size =
            typeof product === "object" && product !== null ? resolveField(product, ["size"]) : "";
          const statusValue =
            typeof product === "object" && product !== null
              ? resolveField(product, ["status", "condition"])
              : "";
          const infoParts = [];
          if (size) {
            const sizeText = toDisplayString(size).trim();
            if (sizeText) {
              infoParts.push(sizeText);
            }
          }
          if (statusValue) {
            const statusText = toDisplayString(statusValue).trim();
            if (statusText) {
              infoParts.push(statusText);
            }
          }
          const info = infoParts.join(" · ");

          const url =
            typeof product === "object" && product !== null
              ? resolveField(product, [
                  "url",
                  "link",
                  "productUrl",
                  "href",
                  "VintageProductUrl",
                  "vintageProductUrl",
                ]) ?? ""
              : "";

          const photos =
            typeof product === "object" && product !== null
              ? toArray(product?.photos ?? product?.images ?? product?.image)
              : [];
          let thumbnail = "";
          if (photos.length > 0) {
            const firstPhoto = photos[0];
            if (typeof firstPhoto === "string") {
              thumbnail = firstPhoto;
            } else if (firstPhoto && typeof firstPhoto === "object") {
              thumbnail =
                resolveField(firstPhoto, [
                  "thumbnail_url",
                  "thumbnailUrl",
                  "url",
                  "imageUrl",
                  "src",
                  "href",
                  "small",
                ]) || resolveField(firstPhoto, ["full_size_url", "fullSizeUrl"]);
            }
          }
          if (!thumbnail && typeof product === "object" && product !== null) {
            thumbnail = resolveField(product, ["image", "imageUrl", "thumbnail", "thumbnailUrl"]);
          }

          return {
            id: identifier,
            title,
            priceText: priceText ? toDisplayString(priceText).trim() : "",
            description,
            info,
            url: url ? toDisplayString(url).trim() : "",
            thumbnail: thumbnail ? toDisplayString(thumbnail).trim() : "",
            raw,
          };
        };

        const cloneProduct = (product) => {
          if (!product || typeof product !== "object") {
            return {};
          }

          if (typeof structuredClone === "function") {
            try {
              return structuredClone(product);
            } catch (error) {
              // Ignore cloning errors and fall back to alternative strategies.
            }
          }

          try {
            return JSON.parse(JSON.stringify(product));
          } catch (error) {
            return { ...product };
          }
        };

        const updateKnownFields = (target, keys, value) => {
          if (!target || typeof target !== "object" || !Array.isArray(keys) || keys.length === 0) {
            return;
          }

          let updated = false;
          keys.forEach((key) => {
            if (key in target) {
              target[key] = value;
              updated = true;
            }
          });

          if (!updated) {
            target[keys[0]] = value;
          }
        };

        const ensureIdentifier = (target) => {
          if (!target || typeof target !== "object") {
            return target;
          }

          const fallbackId = (productId ?? idInput?.value ?? "").toString().trim();
          if (!fallbackId) {
            return target;
          }

          const identifierKeys = ["id", "Id", "ID", "productId", "productID"];
          let found = false;

          identifierKeys.forEach((key) => {
            if (!(key in target)) {
              return;
            }

            const value = target[key];
            if (value != null && String(value).trim() !== "") {
              found = true;
              return;
            }

            target[key] = fallbackId;
            found = true;
          });

          if (!found) {
            target.id = fallbackId;
          }

          return target;
        };

        const duplicateMonittaEntry = (entry, existing = null) => {
          if (!entry || typeof entry !== "object") {
            return null;
          }

          const identifier = entry.id ?? existing?.id;
          if (!identifier) {
            return null;
          }

          const baseRaw =
            entry.raw && typeof entry.raw === "object"
              ? entry.raw
              : existing && existing.raw && typeof existing.raw === "object"
              ? existing.raw
              : { id: identifier };

          let rawClone = cloneProduct(baseRaw);
          if (!rawClone || typeof rawClone !== "object" || Object.keys(rawClone).length === 0) {
            rawClone = { id: identifier };
          } else if (!("id" in rawClone) && identifier) {
            rawClone.id = identifier;
          }

          return {
            id: identifier,
            title: entry.title ?? existing?.title ?? `Produkt Monitta ${identifier}`,
            priceText: entry.priceText ?? existing?.priceText ?? "",
            description: entry.description ?? existing?.description ?? "",
            info: entry.info ?? existing?.info ?? "",
            url: entry.url ?? existing?.url ?? "",
            thumbnail: entry.thumbnail ?? existing?.thumbnail ?? "",
            raw: rawClone,
          };
        };

        const monittaProductsKeys = [
          "monittaStoreProducts",
          "monittaProducts",
          "monittaStoreItems",
          "monittaStore",
          "monittaAssociatedProducts",
        ];

        const monittaIdentifierKeys = ["monittaStoreProductIds", "monittaProductIds", "monittaIds"];

        const sanitizeMonittaEntryForPayload = (entry) => {
          if (entry && typeof entry === "object" && !Array.isArray(entry)) {
            const clone = cloneProduct(entry);
            const identifier = getMonittaIdentifier(clone);
            if (
              identifier &&
              (!("id" in clone) || clone.id == null || String(clone.id).trim() === "")
            ) {
              clone.id = identifier;
            }
            return clone;
          }

          const identifier = getMonittaIdentifier(entry);
          if (!identifier) {
            return null;
          }

          return { id: identifier };
        };

        const sanitizeMonittaEntries = (entries) => {
          if (!Array.isArray(entries)) {
            return [];
          }

          return entries
            .map((item) => sanitizeMonittaEntryForPayload(item))
            .filter(
              (item) =>
                item && typeof item === "object" && !Array.isArray(item) && Object.keys(item).length > 0
            );
        };

        const gatherMonittaIdentifiers = (items) => {
          const identifiers = new Set();
          toArray(items).forEach((item) => {
            const identifier = getMonittaIdentifier(item);
            if (typeof identifier !== "string") {
              return;
            }
            const trimmed = identifier.trim();
            if (trimmed) {
              identifiers.add(trimmed);
            }
          });
          return Array.from(identifiers);
        };

        const gatherNormalizedMonittaIdentifierSet = (items) => {
          const normalized = new Set();
          gatherMonittaIdentifiers(items).forEach((identifier) => {
            normalized.add(identifier.toLowerCase());
          });
          return normalized;
        };

        const getVintageProductIdentifier = (source) => {
          if (source == null) {
            return "";
          }

          if (typeof source === "object" && !Array.isArray(source)) {
            const identifier = resolveField(source, [
              "VintageProductId",
              "vintageProductId",
              "id",
              "Id",
              "ID",
              "productId",
              "productID",
            ]);
            if (identifier != null && identifier !== "") {
              const text = toDisplayString(identifier).trim();
              if (text) {
                return text;
              }
            }

            const urlFallback = resolveField(source, [
              "VintageProductUrl",
              "vintageProductUrl",
              "url",
              "link",
              "productUrl",
              "href",
            ]);
            if (urlFallback != null && urlFallback !== "") {
              const text = toDisplayString(urlFallback).trim();
              if (text) {
                return text;
              }
            }

            const nameFallback = resolveField(source, [
              "VintageProductName",
              "vintageProductName",
              "name",
              "title",
              "productName",
              "label",
            ]);
            if (nameFallback != null && nameFallback !== "") {
              const text = toDisplayString(nameFallback).trim();
              if (text) {
                return text;
              }
            }

            return "";
          }

          return toDisplayString(source).trim();
        };

        const createVintageProductFromMonitta = (entry) => {
          if (!entry || typeof entry !== "object") {
            return null;
          }

          const identifier = getMonittaIdentifier(entry);
          if (!identifier) {
            return null;
          }

          const titleCandidate = resolveField(entry, [
            "VintageProductName",
            "vintageProductName",
            "title",
            "name",
            "productName",
            "label",
          ]);
          const titleText = titleCandidate ? toDisplayString(titleCandidate).trim() : "";
          const urlCandidate = resolveField(entry, [
            "VintageProductUrl",
            "vintageProductUrl",
            "url",
            "link",
            "productUrl",
            "href",
          ]);
          const urlText = urlCandidate ? toDisplayString(urlCandidate).trim() : "";
          const name = titleText || `Produkt Monitta ${identifier}`;

          return {
            VintageProductId: identifier,
            vintageProductId: identifier,
            VintageProductName: name,
            vintageProductName: name,
            VintageProductUrl: urlText,
            vintageProductUrl: urlText,
          };
        };

        const getExistingVintageProducts = (source) => {
          if (!source || typeof source !== "object") {
            return [];
          }

          const candidates = [source?.VintageProducts, source?.vintageProducts, source?.relatedProducts];
          for (const candidate of candidates) {
            const array = toArray(candidate);
            if (array.length > 0) {
              return array.map((item) => cloneProduct(item));
            }
          }

          return [];
        };

        const assignVintageProductsToTarget = (target, entries) => {
          if (!target || typeof target !== "object") {
            return;
          }

          const upperCaseEntries = entries.map((entry) => cloneProduct(entry));
          const lowerCaseEntries = upperCaseEntries.map((entry) => cloneProduct(entry));
          target.VintageProducts = upperCaseEntries;
          target.vintageProducts = lowerCaseEntries;
        };

        const mergeMonittaIntoVintageProducts = (target, monittaEntries, previousIds = new Set()) => {
          if (!target || typeof target !== "object") {
            return;
          }

          const sanitizedEntries = Array.isArray(monittaEntries) ? monittaEntries : [];
          const previousIdValues = Array.isArray(previousIds)
            ? previousIds
            : previousIds instanceof Set
            ? Array.from(previousIds)
            : toArray(previousIds);
          const normalizedPreviousIds = new Set();
          previousIdValues.forEach((value) => {
            const identifier =
              typeof value === "string" ? value : getMonittaIdentifier(value);
            if (typeof identifier === "string") {
              const trimmed = identifier.trim();
              if (trimmed) {
                normalizedPreviousIds.add(trimmed.toLowerCase());
              }
            }
          });

          const currentNormalizedIds = gatherNormalizedMonittaIdentifierSet(sanitizedEntries);
          const idsToReplace = new Set([...normalizedPreviousIds, ...currentNormalizedIds]);

          const existingVintage = getExistingVintageProducts(target).filter((item) => {
            const identifier = getVintageProductIdentifier(item);
            if (!identifier) {
              return true;
            }
            return !idsToReplace.has(identifier.toLowerCase());
          });

          const monittaVintageEntries = sanitizedEntries
            .map((entry) => createVintageProductFromMonitta(entry))
            .filter((entry) => entry && entry.VintageProductId);

          const combined = [...existingVintage, ...monittaVintageEntries];
          assignVintageProductsToTarget(target, combined);
        };

        const assignMonittaProductsToTarget = (target, products) => {
          if (!target || typeof target !== "object") {
            return;
          }

          const baseEntries = (Array.isArray(products) ? products : []).map((entry) =>
            cloneProduct(entry)
          );

          monittaProductsKeys.forEach((key) => {
            target[key] = baseEntries.map((entry) => cloneProduct(entry));
          });
        };

        const assignMonittaIdentifiersToTarget = (target, identifiers) => {
          if (!target || typeof target !== "object") {
            return;
          }

          const baseIdentifiers = Array.isArray(identifiers) ? identifiers : [];
          monittaIdentifierKeys.forEach((key) => {
            target[key] = baseIdentifiers.map((identifier) => identifier);
          });
        };

        const setMonittaStatus = (message, type = "info") => {
          if (!monittaStatusElement) {
            return;
          }

          if (!message) {
            monittaStatusElement.textContent = "";
            monittaStatusElement.hidden = true;
            monittaStatusElement.removeAttribute("data-status-type");
            return;
          }

          monittaStatusElement.hidden = false;
          monittaStatusElement.textContent = message;

          if (type === "info") {
            monittaStatusElement.removeAttribute("data-status-type");
          } else {
            monittaStatusElement.dataset.statusType = type;
          }
        };

        const updateMonittaCount = () => {
          if (!monittaCountElement) {
            return;
          }

          const count = monittaState.selectedMap.size;
          monittaCountElement.textContent = `Wybrano: ${count}`;
        };

        const createMonittaPlaceholder = (message) => {
          const item = document.createElement("li");
          item.className = "placeholder";
          item.textContent = message;
          return item;
        };

        const getFilteredMonittaProducts = () => {
          const term = monittaState.filter.trim().toLowerCase();
          if (!term) {
            return monittaState.allProducts;
          }

          return monittaState.allProducts.filter((entry) => {
            const haystack = [entry.title, entry.priceText, entry.info, entry.description, entry.id]
              .filter((value) => typeof value === "string" && value)
              .join(" ")
              .toLowerCase();
            return haystack.includes(term);
          });
        };

        const renderMonittaList = () => {
          if (!monittaListElement) {
            return;
          }

          monittaListElement.innerHTML = "";
          monittaListElement.setAttribute("aria-busy", monittaState.isLoading ? "true" : "false");

          if (monittaState.isLoading) {
            monittaListElement.appendChild(
              createMonittaPlaceholder("Lista produktów jest wczytywana…")
            );
            return;
          }

          if (monittaState.error && monittaState.allProducts.length === 0) {
            monittaListElement.appendChild(createMonittaPlaceholder(monittaState.error));
            return;
          }

          const products = getFilteredMonittaProducts();

          if (products.length === 0) {
            const message = monittaState.filter
              ? "Brak produktów spełniających kryteria wyszukiwania."
              : "Brak produktów Monitta Store do wyświetlenia.";
            monittaListElement.appendChild(createMonittaPlaceholder(message));
            return;
          }

          const fragment = document.createDocumentFragment();

          products.forEach((entry) => {
            const listItem = document.createElement("li");
            listItem.className = "monitta-option";
            listItem.dataset.monittaId = entry.id;

            const label = document.createElement("label");
            label.className = "monitta-option__label";

            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.value = entry.id;
            checkbox.dataset.monittaId = entry.id;
            checkbox.checked = monittaState.selectedMap.has(entry.id);

            const content = document.createElement("div");
            content.className = "monitta-option__content";

            const title = document.createElement("span");
            title.className = "monitta-option__title";
            title.textContent = entry.title;
            content.appendChild(title);

            if (entry.priceText || entry.info) {
              const meta = document.createElement("span");
              meta.className = "monitta-option__meta";
              if (entry.priceText && entry.info) {
                meta.textContent = `${entry.priceText} · ${entry.info}`;
              } else {
                meta.textContent = entry.priceText || entry.info;
              }
              content.appendChild(meta);
            }

            if (entry.description) {
              const description = document.createElement("span");
              description.className = "monitta-option__description";
              description.textContent = entry.description;
              content.appendChild(description);
            }

            label.appendChild(checkbox);
            label.appendChild(content);
            listItem.appendChild(label);

            if (entry.url) {
              const link = document.createElement("a");
              link.href = entry.url;
              link.target = "_blank";
              link.rel = "noopener";
              link.className = "monitta-option__link";
              link.textContent = "Zobacz na Monitta Store";
              listItem.appendChild(link);
            }

            fragment.appendChild(listItem);
          });

          monittaListElement.appendChild(fragment);
        };

        const renderMonittaSelected = () => {
          if (!monittaSelectedElement) {
            return;
          }

          monittaSelectedElement.innerHTML = "";
          const selected = Array.from(monittaState.selectedMap.values());
          if (selected.length === 0) {
            const placeholder = document.createElement("p");
            placeholder.className = "placeholder";
            placeholder.textContent = "Nie wybrano produktów Monitta Store.";
            monittaSelectedElement.appendChild(placeholder);
            return;
          }

          selected.sort((a, b) => a.title.localeCompare(b.title, "pl", { sensitivity: "base" }));

          const list = document.createElement("ul");
          list.className = "monitta-selected-list";

          selected.forEach((entry) => {
            const item = document.createElement("li");
            item.className = "monitta-selected-item";
            item.dataset.monittaId = entry.id;

            const content = document.createElement("div");
            content.className = "monitta-selected-content";

            const title = document.createElement("span");
            title.className = "monitta-selected-title";
            title.textContent = entry.title;
            content.appendChild(title);

            const metaPieces = [];
            if (entry.priceText) {
              metaPieces.push(entry.priceText);
            }
            if (entry.info) {
              metaPieces.push(entry.info);
            }

            if (metaPieces.length > 0) {
              const meta = document.createElement("span");
              meta.className = "monitta-selected-meta";
              meta.textContent = metaPieces.join(" · ");
              content.appendChild(meta);
            } else if (entry.description) {
              const meta = document.createElement("span");
              meta.className = "monitta-selected-meta";
              meta.textContent = entry.description;
              content.appendChild(meta);
            }

            const actions = document.createElement("div");
            actions.className = "monitta-selected-actions";

            if (entry.url) {
              const link = document.createElement("a");
              link.href = entry.url;
              link.target = "_blank";
              link.rel = "noopener";
              link.className = "monitta-selected-link";
              link.textContent = "Zobacz";
              actions.appendChild(link);
            }

            const removeButton = document.createElement("button");
            removeButton.type = "button";
            removeButton.className = "monitta-remove";
            removeButton.dataset.monittaRemove = entry.id;
            removeButton.textContent = "Usuń";
            actions.appendChild(removeButton);

            item.appendChild(content);
            item.appendChild(actions);
            list.appendChild(item);
          });

          monittaSelectedElement.appendChild(list);
        };

        const getMonittaPayload = () => {
          const payload = [];
          monittaState.selectedMap.forEach((entry) => {
            if (!entry) {
              return;
            }

            const base =
              entry.raw && typeof entry.raw === "object" ? entry.raw : { id: entry.id };
            let clone = cloneProduct(base);
            if (!clone || typeof clone !== "object" || Object.keys(clone).length === 0) {
              clone = { id: entry.id };
            } else if (entry.id && !("id" in clone)) {
              clone.id = entry.id;
            }
            payload.push(clone);
          });
          return payload;
        };

        const updateMonittaSelectionInProduct = () => {
          if (!currentProduct || typeof currentProduct !== "object") {
            return;
          }

          const previousIdentifierValues = [];
          [
            currentProduct?.monittaStoreProducts,
            currentProduct?.monittaStoreProductIds,
            currentProduct?.monittaProducts,
            currentProduct?.monittaProductIds,
            currentProduct?.monittaStoreItems,
            currentProduct?.monittaIds,
          ].forEach((source) => {
            previousIdentifierValues.push(...toArray(source));
          });

          const previousIdentifiers = gatherNormalizedMonittaIdentifierSet(previousIdentifierValues);

          const selectedPayload = getMonittaPayload();
          const sanitizedSelected = sanitizeMonittaEntries(selectedPayload);
          const identifiers = gatherMonittaIdentifiers(sanitizedSelected);

          assignMonittaProductsToTarget(currentProduct, sanitizedSelected);
          assignMonittaIdentifiersToTarget(currentProduct, identifiers);
          mergeMonittaIntoVintageProducts(currentProduct, sanitizedSelected, previousIdentifiers);
        };

        const setMonittaSelectedFromProduct = (product) => {
          monittaState.selectedMap.clear();

          const candidateKeys = [
            "monittaStoreProducts",
            "monittaProducts",
            "monittaStoreItems",
            "monittaStore",
            "monittaAssociatedProducts",
          ];

          candidateKeys.forEach((key) => {
            const items = toArray(product?.[key]);
            items.forEach((item) => {
              const entry = createMonittaEntry(item);
              if (!entry) {
                return;
              }
              const selectedEntry = duplicateMonittaEntry(entry);
              if (selectedEntry) {
                monittaState.selectedMap.set(selectedEntry.id, selectedEntry);
              }
            });
          });

          const includeVintageMonittaProducts = (source) => {
            toArray(source).forEach((item) => {
              if (!item || typeof item !== "object" || Array.isArray(item)) {
                return;
              }

              const identifierCandidate = resolveField(
                item,
                ["VintageProductId", "vintageProductId"],
                ""
              );
              if (!identifierCandidate || String(identifierCandidate).trim() === "") {
                return;
              }

              const entry = createMonittaEntry(item);
              if (!entry) {
                return;
              }

              const selectedEntry = duplicateMonittaEntry(
                entry,
                monittaState.selectedMap.get(entry.id) ?? null
              );
              if (selectedEntry) {
                monittaState.selectedMap.set(selectedEntry.id, selectedEntry);
              }
            });
          };

          includeVintageMonittaProducts(product?.VintageProducts);
          includeVintageMonittaProducts(product?.vintageProducts);

          const idCandidates = toArray(
            product?.monittaStoreProductIds ?? product?.monittaProductIds ?? product?.monittaIds
          );
          idCandidates.forEach((candidate) => {
            const entry =
              typeof candidate === "object" && candidate !== null
                ? createMonittaEntry(candidate)
                : createMonittaEntry({ id: candidate });
            if (!entry) {
              return;
            }
            const existing = monittaState.selectedMap.get(entry.id);
            const selectedEntry = duplicateMonittaEntry(entry, existing ?? null);
            if (selectedEntry) {
              monittaState.selectedMap.set(selectedEntry.id, selectedEntry);
            }
          });

          renderMonittaSelected();
          updateMonittaSelectionInProduct();
          updateMonittaCount();
          renderMonittaList();
        };

        const loadMonittaProducts = async () => {
          if (!monittaListElement) {
            return;
          }

          monittaState.isLoading = true;
          monittaState.error = null;
          monittaListElement.setAttribute("aria-busy", "true");
          setMonittaStatus("Trwa wczytywanie produktów Monitta Store…");

          try {
            const response = await fetch(monittaEndpoint);
            if (!response.ok) {
              throw new Error(`Żądanie nie powiodło się. Kod odpowiedzi: ${response.status}`);
            }

            const payload = await response.json();
            const rawProducts = toArray(payload);
            const uniqueEntries = new Map();
            rawProducts.forEach((item) => {
              const entry = createMonittaEntry(item);
              if (!entry || uniqueEntries.has(entry.id)) {
                return;
              }
              uniqueEntries.set(entry.id, entry);
            });

            const entries = Array.from(uniqueEntries.values());
            entries.sort((a, b) => a.title.localeCompare(b.title, "pl", { sensitivity: "base" }));

            monittaState.allProducts = entries;
            monittaState.allProductsMap = uniqueEntries;
            monittaState.error = null;

            monittaState.selectedMap.forEach((existingEntry, id) => {
              const datasetEntry = uniqueEntries.get(id);
              if (!datasetEntry) {
                return;
              }
              const mergedEntry = duplicateMonittaEntry(datasetEntry, existingEntry);
              if (mergedEntry) {
                monittaState.selectedMap.set(id, mergedEntry);
              }
            });

            if (entries.length === 0) {
              setMonittaStatus("Brak produktów Monitta Store do wyświetlenia.");
            } else {
              setMonittaStatus(`Wczytano ${entries.length} produktów Monitta Store.`);
            }
          } catch (error) {
            console.error("Błąd podczas wczytywania produktów Monitta Store:", error);
            monittaState.error = "Nie udało się pobrać listy produktów Monitta Store.";
            setMonittaStatus(monittaState.error, "error");
          } finally {
            monittaState.isLoading = false;
            monittaListElement.setAttribute("aria-busy", "false");
            renderMonittaList();
            renderMonittaSelected();
            updateMonittaSelectionInProduct();
            updateMonittaCount();
          }
        };

        const isImageFile = (file) => {
          if (!file) {
            return false;
          }

          if (file.type && file.type.startsWith("image/")) {
            return true;
          }

          const name = (file.name ?? "").toLowerCase();
          const extensions = [
            ".png",
            ".jpg",
            ".jpeg",
            ".jfif",
            ".pjpeg",
            ".gif",
            ".bmp",
            ".webp",
            ".avif",
            ".heic",
            ".heif",
          ];

          return extensions.some((extension) => name.endsWith(extension));
        };

        const separateImageFiles = (fileList) => {
          const originalFiles = Array.from(fileList ?? []);
          const imageFiles = originalFiles.filter(isImageFile);

          return { originalFiles, imageFiles };
        };

        const getSelectedImageFiles = () => {
          const { imageFiles } = separateImageFiles(newImagesInput?.files);
          return imageFiles;
        };

        const renderImages = (product) => {
          if (!imagesContainer) {
            return;
          }

          const images = toArray(product?.images ?? product?.image ?? product?.photos);
          imagesContainer.innerHTML = "";

          let rendered = 0;
          images.forEach((image, index) => {
            const url =
              typeof image === "string"
                ? image
                : resolveField(image, ["url", "imageUrl", "src", "href", "link"]);

            if (!url) {
              return;
            }

            const altText =
              typeof image === "object" && image !== null
                ? resolveField(image, ["alt", "description", "title"], `Zdjęcie ${index + 1}`)
                : `Zdjęcie ${index + 1}`;

            const figure = document.createElement("figure");
            const img = document.createElement("img");
            const caption = document.createElement("figcaption");

            img.src = url;
            img.loading = "lazy";
            img.alt = altText;
            caption.textContent = altText;

            figure.appendChild(img);
            figure.appendChild(caption);
            imagesContainer.appendChild(figure);
            rendered += 1;
          });

          if (rendered === 0) {
            const empty = document.createElement("p");
            empty.className = "placeholder";
            empty.textContent = "Brak zdjęć do wyświetlenia.";
            imagesContainer.appendChild(empty);
          }
        };

        const renderSelectedImages = (fileList) => {
          if (!newImagesPreview) {
            return;
          }

          newImagesPreview.innerHTML = "";
          newImagesPreview.setAttribute("aria-busy", "true");

          const { originalFiles, imageFiles } = separateImageFiles(fileList);

          if (imageFiles.length === 0) {
            const empty = document.createElement("p");
            empty.className = "placeholder";
            empty.textContent =
              originalFiles.length > 0
                ? "Wybrane pliki nie są obsługiwanymi obrazami."
                : "Nie wybrano jeszcze nowych zdjęć.";
            newImagesPreview.appendChild(empty);
            newImagesPreview.setAttribute("aria-busy", "false");
            return;
          }

          if (typeof FileReader === "undefined") {
            const info = document.createElement("p");
            info.className = "placeholder";
            info.textContent = "Twoja przeglądarka nie obsługuje podglądu wybranych zdjęć.";
            newImagesPreview.appendChild(info);
            newImagesPreview.setAttribute("aria-busy", "false");
            return;
          }

          let pending = imageFiles.length;
          const markReady = () => {
            pending -= 1;
            if (pending <= 0) {
              newImagesPreview.setAttribute("aria-busy", "false");
            }
          };

          imageFiles.forEach((file, index) => {
            const figure = document.createElement("figure");
            const img = document.createElement("img");
            const caption = document.createElement("figcaption");
            const label = file.name && file.name.trim() ? file.name : `Nowe zdjęcie ${index + 1}`;

            img.loading = "lazy";
            img.alt = label;
            caption.textContent = label;

            figure.appendChild(img);
            figure.appendChild(caption);
            newImagesPreview.appendChild(figure);

            const reader = new FileReader();
            reader.addEventListener("load", () => {
              img.src = reader.result;
              markReady();
            });
            reader.addEventListener("error", markReady);
            reader.addEventListener("abort", markReady);
            try {
              reader.readAsDataURL(file);
            } catch (error) {
              console.error("Nie udało się wczytać pliku graficznego:", error);
              markReady();
            }
          });
        };

        renderSelectedImages(newImagesInput?.files ?? []);

        if (newImagesInput) {
          newImagesInput.addEventListener("change", () => {
            renderSelectedImages(newImagesInput.files);
          });
        }

        if (monittaSearchInput) {
          monittaSearchInput.addEventListener("input", () => {
            monittaState.filter = monittaSearchInput.value ?? "";
            renderMonittaList();
          });
        }

        if (monittaListElement) {
          monittaListElement.addEventListener("change", (event) => {
            const target = event.target;
            if (!target || !(target instanceof HTMLInputElement)) {
              return;
            }
            if (!target.matches('input[type="checkbox"][data-monitta-id]')) {
              return;
            }

            const identifier = target.dataset.monittaId;
            if (!identifier) {
              return;
            }

            if (target.checked) {
              const datasetEntry = monittaState.allProductsMap.get(identifier);
              if (datasetEntry) {
                const entry = duplicateMonittaEntry(
                  datasetEntry,
                  monittaState.selectedMap.get(identifier) ?? null
                );
                if (entry) {
                  monittaState.selectedMap.set(identifier, entry);
                }
              } else {
                const fallbackEntry = createMonittaEntry({ id: identifier });
                if (fallbackEntry) {
                  const entry = duplicateMonittaEntry(
                    fallbackEntry,
                    monittaState.selectedMap.get(identifier) ?? null
                  );
                  if (entry) {
                    monittaState.selectedMap.set(identifier, entry);
                  }
                }
              }
            } else {
              monittaState.selectedMap.delete(identifier);
            }

            renderMonittaSelected();
            updateMonittaSelectionInProduct();
            updateMonittaCount();
          });
        }

        if (monittaSelectedElement) {
          monittaSelectedElement.addEventListener("click", (event) => {
            const target = event.target;
            if (!target || !(target instanceof HTMLElement)) {
              return;
            }

            if (!target.matches("button[data-monitta-remove]")) {
              return;
            }

            const identifier = target.dataset.monittaRemove;
            if (!identifier) {
              return;
            }

            monittaState.selectedMap.delete(identifier);

            if (monittaListElement) {
              const checkboxes = monittaListElement.querySelectorAll(
                'input[type="checkbox"][data-monitta-id]'
              );
              checkboxes.forEach((checkbox) => {
                if (
                  checkbox instanceof HTMLInputElement &&
                  checkbox.dataset.monittaId === identifier
                ) {
                  checkbox.checked = false;
                }
              });
            }

            renderMonittaSelected();
            updateMonittaSelectionInProduct();
            updateMonittaCount();
          });
        }

        const renderVintageProducts = (product) => {
          if (!vintageList) {
            return;
          }

          const vintageProducts = toArray(
            product?.VintageProducts ?? product?.vintageProducts ?? product?.relatedProducts
          );
          vintageList.innerHTML = "";

          if (vintageProducts.length === 0) {
            const empty = document.createElement("li");
            empty.className = "placeholder";
            empty.textContent = "Brak powiązanych produktów vintage.";
            vintageList.appendChild(empty);
            return;
          }

          vintageProducts.forEach((item, index) => {
            const listItem = document.createElement("li");
            listItem.className = "vintage-item";

            if (item && typeof item === "object") {
              const title = resolveField(
                item,
                [
                  "name",
                  "title",
                  "productName",
                  "label",
                  "VintageProductName",
                  "vintageProductName",
                ],
                `Produkt ${index + 1}`
              );
              const url = resolveField(item, [
                "url",
                "link",
                "productUrl",
                "href",
                "VintageProductUrl",
                "vintageProductUrl",
              ]);
              const price = resolveField(item, ["price", "amount", "value"]);
              const currency = resolveField(item, ["currency", "currencyCode", "priceCurrency"], "");
              const description = resolveField(item, ["description", "summary", "details"]);

              if (url) {
                const anchor = document.createElement("a");
                anchor.href = url;
                anchor.target = "_blank";
                anchor.rel = "noopener";
                anchor.textContent = title;
                listItem.appendChild(anchor);
              } else {
                const nameElement = document.createElement("strong");
                nameElement.textContent = title;
                listItem.appendChild(nameElement);
              }

              if (price) {
                const priceElement = document.createElement("small");
                priceElement.textContent = currency ? `${price} ${currency}` : `${price}`;
                listItem.appendChild(priceElement);
              }

              if (description) {
                const descriptionElement = document.createElement("p");
                descriptionElement.textContent = description;
                descriptionElement.style.margin = "0";
                descriptionElement.style.color = "#4b5563";
                listItem.appendChild(descriptionElement);
              }
            } else {
              listItem.textContent = String(item);
            }

            vintageList.appendChild(listItem);
          });
        };

        const populateForm = (product) => {
          const safeProduct = product && typeof product === "object" ? product : {};

          if (idInput) {
            idInput.value = productId ?? "";
          }

          const resolvedName = resolveField(
            safeProduct,
            ["name", "title", "productName", "label"],
            ""
          );
          if (nameInput) {
            nameInput.value = toDisplayString(resolvedName);
          }

          const resolvedDescription = resolveField(
            safeProduct,
            ["description", "summary", "details", "productDescription"],
            ""
          );
          if (descriptionInput) {
            descriptionInput.value = toDisplayString(resolvedDescription);
          }

          renderImages(safeProduct);
          renderVintageProducts(safeProduct);
          setMonittaSelectedFromProduct(safeProduct);

          if (rawJson) {
            const hasContent = hasProductData(safeProduct);
            rawJson.textContent = hasContent
              ? JSON.stringify(safeProduct, null, 2)
              : "Brak danych";
          }

          if (newImagesInput) {
            newImagesInput.value = "";
          }
          renderSelectedImages(newImagesInput?.files ?? []);

          const nameForTitle = nameInput ? nameInput.value.trim() : "";
          document.title = nameForTitle
            ? `${nameForTitle} — Edycja produktu`
            : "Edycja produktu";
        };

        const assignProduct = (product) => {
          currentProduct = cloneProduct(product);
          populateForm(currentProduct);

          if (form) {
            form.hidden = false;
          }

          updateSaveButtonState();
        };

        const fetchProductDetails = async () => {
          if (!productId) {
            throw new Error("Brak identyfikatora produktu.");
          }

          const endpoint = `${apiBaseUrl}/${encodeURIComponent(productId)}`;
          const response = await fetch(endpoint);

          if (!response.ok) {
            throw new Error(`Żądanie nie powiodło się. Kod odpowiedzi: ${response.status}`);
          }

          const product = await response.json();

          if (!product || typeof product !== "object") {
            throw new Error("Serwer zwrócił nieoczekiwany format danych.");
          }

          return product;
        };

        const buildUpdatePayload = () => {
          if (!currentProduct || typeof currentProduct !== "object") {
            return null;
          }

          const payload = cloneProduct(currentProduct);
          const sanitizedName = nameInput ? nameInput.value.trim() : "";
          const sanitizedDescription = descriptionInput ? descriptionInput.value.trim() : "";

          updateKnownFields(payload, ["name", "title", "productName", "label"], sanitizedName);
          updateKnownFields(
            payload,
            ["description", "summary", "details", "productDescription"],
            sanitizedDescription
          );
          ensureIdentifier(payload);

          const previousIdentifierValues = [];
          [
            payload?.monittaStoreProducts,
            payload?.monittaStoreProductIds,
            payload?.monittaProducts,
            payload?.monittaProductIds,
            payload?.monittaStoreItems,
            payload?.monittaIds,
          ].forEach((source) => {
            previousIdentifierValues.push(...toArray(source));
          });
          const previousIdentifiers = gatherNormalizedMonittaIdentifierSet(previousIdentifierValues);

          const monittaProductsSource = getMonittaPayload();
          const sanitizedMonittaProducts = sanitizeMonittaEntries(monittaProductsSource);
          const monittaIdentifiers = gatherMonittaIdentifiers(sanitizedMonittaProducts);

          assignMonittaProductsToTarget(payload, sanitizedMonittaProducts);
          assignMonittaIdentifiersToTarget(payload, monittaIdentifiers);
          mergeMonittaIntoVintageProducts(payload, sanitizedMonittaProducts, previousIdentifiers);

          assignMonittaProductsToTarget(currentProduct, sanitizedMonittaProducts);
          assignMonittaIdentifiersToTarget(currentProduct, monittaIdentifiers);
          mergeMonittaIntoVintageProducts(currentProduct, sanitizedMonittaProducts, previousIdentifiers);

          return payload;
        };

        const uploadProductImages = async (id, files) => {
          if (!id || !Array.isArray(files) || files.length === 0) {
            return null;
          }

          if (typeof FormData === "undefined") {
            throw new Error("Przesyłanie zdjęć nie jest obsługiwane w tej przeglądarce.");
          }

          const formData = new FormData();
          files.forEach((file, index) => {
            if (!file) {
              return;
            }

            const fallbackName = `image-${index + 1}`;
            const fileName = file.name && file.name.trim() ? file.name : fallbackName;
            formData.append("files", file, fileName);
          });

          const uploadEndpoint = `${uploadBaseUrl}/${encodeURIComponent(id)}`;
          const response = await fetch(uploadEndpoint, {
            method: "POST",
            body: formData,
          });

          if (!response.ok) {
            throw new Error(
              `Żądanie przesłania zdjęć nie powiodło się. Kod odpowiedzi: ${response.status}`
            );
          }

          try {
            return await response.json();
          } catch (error) {
            return null;
          }
        };

        const saveProduct = async () => {
          if (isSaving) {
            return;
          }

          if (!productId) {
            setStatus(
              "Brak identyfikatora produktu. Upewnij się, że adres URL zawiera parametr ?productID=…",
              "error"
            );
            return;
          }

          if (!currentProduct || !hasProductData(currentProduct)) {
            setStatus("Brak danych produktu do zapisania.", "error");
            return;
          }

          if (form && typeof form.reportValidity === "function" && !form.reportValidity()) {
            return;
          }

          const payload = buildUpdatePayload();

          if (!payload) {
            setStatus("Nie udało się przygotować danych produktu do zapisu.", "error");
            return;
          }

          const selectedFiles = getSelectedImageFiles();

          setSavingState(true);
          setStatus("Trwa zapisywanie zmian produktu…");

          try {
            const endpoint = `${apiBaseUrl}/${encodeURIComponent(productId)}`;
            const response = await fetch(endpoint, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payload),
            });

            if (!response.ok) {
              throw new Error(`Żądanie nie powiodło się. Kod odpowiedzi: ${response.status}`);
            }

            let updatedProduct = null;
            try {
              updatedProduct = await response.json();
            } catch (error) {
              updatedProduct = null;
            }

            if (updatedProduct && typeof updatedProduct === "object") {
              assignProduct(updatedProduct);
            } else {
              try {
                const refreshed = await fetchProductDetails();
                assignProduct(refreshed);
              } catch (refreshError) {
                console.error("Błąd podczas odświeżania danych produktu:", refreshError);
                assignProduct(payload);
              }
            }

            if (selectedFiles.length > 0) {
              setStatus(
                "Zmiany produktu zostały zapisane. Trwa przesyłanie wybranych zdjęć…"
              );

              try {
                const refreshedProduct = await uploadProductImages(productId, selectedFiles);

                if (refreshedProduct && typeof refreshedProduct === "object") {
                  assignProduct(refreshedProduct);
                  setStatus("Zmiany produktu oraz zdjęcia zostały zapisane.", "success");
                } else {
                  setStatus(
                    "Zmiany produktu zostały zapisane, ale nie udało się odświeżyć danych po przesłaniu zdjęć.",
                    "error"
                  );
                }
              } catch (uploadError) {
                console.error("Błąd podczas przesyłania zdjęć produktu:", uploadError);
                setStatus(
                  "Zmiany produktu zostały zapisane, ale nie udało się przesłać nowych zdjęć.",
                  "error"
                );
              }
            } else {
              setStatus("Zmiany produktu zostały zapisane.", "success");
            }
          } catch (error) {
            console.error("Błąd podczas zapisywania produktu:", error);
            setStatus(
              "Nie udało się zapisać zmian produktu. Spróbuj ponownie.",
              "error"
            );
          } finally {
            setSavingState(false);
          }
        };

        const loadProduct = async () => {
          if (!productId) {
            setStatus(
              "Brak identyfikatora produktu w adresie URL. Użyj parametru ?productID=…",
              "error"
            );

            if (form) {
              form.hidden = true;
            }

            currentProduct = null;
            updateSaveButtonState();

            renderImages({});
            renderVintageProducts({});
            setMonittaSelectedFromProduct({});
            if (rawJson) {
              rawJson.textContent = "Brak danych";
            }
            if (newImagesInput) {
              newImagesInput.value = "";
            }
            renderSelectedImages(newImagesInput?.files ?? []);
            document.title = "Edycja produktu";
            return;
          }

          setStatus("Trwa wczytywanie danych produktu…");

          try {
            const product = await fetchProductDetails();
            assignProduct(product);
            setStatus("Dane produktu zostały pomyślnie wczytane.", "success");
          } catch (error) {
            console.error("Błąd podczas wczytywania danych produktu:", error);
            setStatus(
              "Nie udało się wczytać szczegółów produktu. Upewnij się, że podany identyfikator jest poprawny.",
              "error"
            );

            if (rawJson) {
              rawJson.textContent = "Brak danych";
            }
            renderImages({});
            renderVintageProducts({});
            setMonittaSelectedFromProduct({});
            if (newImagesInput) {
              newImagesInput.value = "";
            }
            renderSelectedImages(newImagesInput?.files ?? []);
            document.title = "Edycja produktu";

            currentProduct = null;
            if (form) {
              form.hidden = true;
            }
            updateSaveButtonState();
          }
        };

        if (saveButton) {
          saveButton.addEventListener("click", saveProduct);
        }

        renderMonittaList();
        renderMonittaSelected();
        updateMonittaCount();
        loadMonittaProducts();

        loadProduct();
      })();
    </script>
  </body>
</html>
