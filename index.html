<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vinted Wardrobe Items</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 2rem;
        background-color: #fafafa;
        color: #202124;
      }

      h1 {
        margin-bottom: 1rem;
      }

      p.description {
        margin-bottom: 1.5rem;
        color: #5f6368;
      }

      ul {
        list-style: disc;
        padding-left: 1.5rem;
      }

      li {
        margin-bottom: 1rem;
      }

      li img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 8px;
        margin-right: 0.75rem;
        vertical-align: middle;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      }

      li a {
        font-weight: 600;
        color: #1a73e8;
        text-decoration: none;
        vertical-align: middle;
      }

      li a:hover {
        text-decoration: underline;
      }

      #status-message {
        color: #5f6368;
      }
    </style>
  </head>
  <body>
    <h1>Wardrobe items</h1>
    <p class="description">
      Live list of items fetched from the Vinted wardrobe API.
    </p>
    <p id="status-message">Preparing secure session…</p>
    <ul id="items-list"></ul>

    <script>
      const API_URL = "https://www.vinted.pl/api/v2/wardrobe/146342127/items";
      const MEMBER_URL = "https://www.vinted.pl/member/146342127";
      const listElement = document.getElementById("items-list");
      const statusElement = document.getElementById("status-message");

      const CORS_PROXY_BASE = "https://cors.isomorphic-git.org/";
      let usingCorsProxy = false;

      function buildRequestUrl(url) {
        return usingCorsProxy ? `${CORS_PROXY_BASE}${url}` : url;
      }

      function normalizeRequestOptions(options = {}) {
        const normalized = { ...options };

        if (usingCorsProxy) {
          normalized.mode = "cors";
          normalized.credentials = "omit";
        } else {
          if (!normalized.mode) {
            normalized.mode = "cors";
          }

          if (!normalized.credentials) {
            normalized.credentials = "include";
          }
        }

        return normalized;
      }

      async function fetchWithCorsSupport(url, options = {}, { allowProxyRetry = true } = {}) {
        const requestUrl = buildRequestUrl(url);
        const finalOptions = normalizeRequestOptions(options);

        try {
          const response = await fetch(requestUrl, finalOptions);

          if (!response.ok && allowProxyRetry && !usingCorsProxy) {
            if (response.status === 401 || response.status === 403) {
              console.warn(
                `Received ${response.status} from ${url}. Retrying via proxy to bypass potential cross-origin/session enforcement.`,
              );
              usingCorsProxy = true;
              statusElement.textContent =
                "Encountered cross-origin restrictions. Retrying via public proxy…";
              statusElement.style.display = "block";
              return fetchWithCorsSupport(url, options, { allowProxyRetry: false });
            }
          }

          return response;
        } catch (error) {
          if (allowProxyRetry && !usingCorsProxy) {
            console.warn("Direct request failed (likely due to CORS). Retrying via proxy.", error);
            usingCorsProxy = true;
            statusElement.textContent =
              "Encountered cross-origin restrictions. Retrying via public proxy…";
            statusElement.style.display = "block";
            return fetchWithCorsSupport(url, options, { allowProxyRetry: false });
          }

          throw error;
        }
      }

      function resolveImageUrl(item) {
        if (!item) {
          return undefined;
        }

        const photo = item.photo || (Array.isArray(item.photos) ? item.photos[0] : undefined);
        if (!photo) {
          return undefined;
        }

        const thumbnails = photo.thumbnails || {};
        return (
          thumbnails?.small?.url ||
          thumbnails?.medium?.url ||
          thumbnails?.large?.url ||
          photo.url
        );
      }

      async function primeSession() {
        try {
          const response = await fetchWithCorsSupport(
            MEMBER_URL,
            {
              credentials: "include",
              mode: "cors",
            },
            { allowProxyRetry: true },
          );

          if (!response.ok) {
            throw new Error(`Session request failed with status ${response.status}`);
          }

          if (usingCorsProxy) {
            return "";
          }

          const cookieFromHeader = response.headers?.get?.("set-cookie");
          if (cookieFromHeader) {
            return cookieFromHeader;
          }

          if (typeof document !== "undefined" && document.cookie) {
            return document.cookie;
          }
        } catch (error) {
          console.warn("Unable to prime authenticated session", error);
        }

        return "";
      }

      async function fetchWardrobeItems(sessionCookie) {
        const headers = new Headers({
          accept: "application/json",
        });

        if (sessionCookie) {
          try {
            headers.set("Cookie", sessionCookie);
          } catch (error) {
            console.warn("Unable to forward session cookie header directly", error);
          }
        }

        const response = await fetchWithCorsSupport(
          API_URL,
          {
            headers,
            credentials: "include",
            mode: "cors",
          },
        );

        if (!response.ok) {
          throw new Error(`Request failed with status ${response.status}`);
        }

        return response.json();
      }

      async function loadItems() {
        try {
          const sessionCookie = await primeSession();

          statusElement.textContent = "Loading items…";

          const payload = await fetchWardrobeItems(sessionCookie);
          const items = Array.isArray(payload.items) ? payload.items : [];

          if (items.length === 0) {
            statusElement.textContent = "No items found.";
            return;
          }

          if (usingCorsProxy) {
            statusElement.textContent =
              "Fetched via public proxy because the API does not allow cross-origin requests.";
            statusElement.style.display = "block";
          } else {
            statusElement.textContent = "";
            statusElement.style.display = "none";
          }

          items.forEach((item) => {
            const listItem = document.createElement("li");

            const imageUrl = resolveImageUrl(item);
            if (imageUrl) {
              const image = document.createElement("img");
              image.src = imageUrl;
              image.alt = item.title || "Wardrobe item photo";
              listItem.appendChild(image);
            }

            const link = document.createElement("a");
            link.href = item.url || `https://www.vinted.pl/items/${item.id}`;
            link.target = "_blank";
            link.rel = "noopener noreferrer";
            link.textContent = item.title || `Item #${item.id}`;
            listItem.appendChild(link);

            listElement.appendChild(listItem);
          });
        } catch (error) {
          console.error("Unable to load items", error);
          statusElement.textContent = "Unable to load items. Please try again later.";
          statusElement.style.display = "block";
        }
      }

      loadItems();
    </script>
  </body>
</html>
