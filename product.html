<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Monitta Store – Product details</title>
    <style>
      :root {
        color-scheme: light;
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont,
          sans-serif;
      }

      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: radial-gradient(circle at top left, #eef2ff, #f8fafc 45%, #f1f5f9);
        color: #1f2933;
      }

      main {
        width: min(960px, calc(100% - 2.75rem));
        margin: 0 auto;
        padding: clamp(2.5rem, 5vw, 4.5rem) 0 clamp(3rem, 6vw, 4.75rem);
      }

      header {
        text-align: left;
        margin-bottom: clamp(1.5rem, 5vw, 2.25rem);
      }

      .back-link {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        margin: 0;
        color: #1a56db;
        text-decoration: none;
        font-weight: 600;
        transition: color 0.2s ease;
      }

      .header-actions {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 0.75rem;
        flex-wrap: wrap;
        margin-bottom: 1.5rem;
      }

      .edit-link {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        margin-left: auto;
        padding: 0.5rem 1.15rem;
        border-radius: 999px;
        background: linear-gradient(120deg, #6366f1, #3b82f6);
        color: #ffffff;
        text-decoration: none;
        font-weight: 600;
        transition: transform 0.2s ease, filter 0.2s ease, box-shadow 0.2s ease;
      }

      .edit-link:hover,
      .edit-link:focus-visible {
        filter: brightness(1.05);
        transform: translateY(-1px);
        box-shadow: 0 12px 24px rgba(79, 70, 229, 0.35);
      }

      .edit-link:focus {
        outline: none;
      }

      .back-link:hover,
      .back-link:focus {
        color: #1e429f;
        text-decoration: underline;
        outline: none;
      }

      #status {
        margin: 0 auto clamp(1.5rem, 4vw, 2.25rem);
        max-width: 60ch;
        text-align: center;
        color: #3d4852;
        font-weight: 500;
      }

      #product-card {
        background: #ffffff;
        border-radius: 22px;
        box-shadow: 0 24px 60px rgba(15, 23, 42, 0.12);
        padding: clamp(1.5rem, 4vw, 2.5rem);
      }

      .product-card__layout {
        display: grid;
        gap: clamp(1.75rem, 4vw, 2.75rem);
        grid-template-columns: minmax(240px, 0.85fr) minmax(260px, 1fr);
        align-items: stretch;
      }

      .product-overview {
        display: flex;
        flex-direction: column;
        gap: clamp(1.25rem, 3vw, 1.85rem);
        min-height: 100%;
      }

      .product-info {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        padding: clamp(1rem, 2.5vw, 1.35rem);
        border-radius: 18px;
        background: linear-gradient(135deg, rgba(79, 70, 229, 0.12), rgba(14, 165, 233, 0.1));
        box-shadow: inset 0 0 0 1px rgba(99, 102, 241, 0.14);
      }

      .product-info__title {
        margin: 0;
        font-size: clamp(1.65rem, 3vw, 2rem);
        font-weight: 700;
        letter-spacing: -0.01em;
        color: #0f172a;
      }

      .product-info__description {
        margin: 0;
        color: #334155;
        font-size: 1rem;
        line-height: 1.6;
      }

      .product-info__description--empty {
        color: #64748b;
        font-style: italic;
      }

      .product-vintage {
        display: flex;
        flex-direction: column;
        gap: 0.85rem;
        background: linear-gradient(135deg, rgba(96, 165, 250, 0.12), rgba(99, 102, 241, 0.08));
        border-radius: 18px;
        padding: clamp(1rem, 2.2vw, 1.25rem);
        box-shadow: inset 0 0 0 1px rgba(99, 102, 241, 0.12);
        min-height: 100%;
        flex: 1 1 auto;
      }

      .product-vintage__heading {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
        color: #1e3a8a;
      }

      .product-vintage__empty {
        margin: 0;
        color: #4b5563;
        font-size: 0.95rem;
      }

      .product-vintage__list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .product-vintage__item {
        list-style: none;
      }

      .product-vintage__link {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        text-decoration: none;
        color: inherit;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 16px;
        padding: 0.6rem 0.7rem;
        transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
      }

      .product-vintage__link:hover,
      .product-vintage__link:focus {
        background: rgba(255, 255, 255, 0.95);
        transform: translateY(-1px);
        box-shadow: 0 12px 24px rgba(15, 23, 42, 0.12);
        outline: none;
      }

      .product-vintage__thumb {
        flex: 0 0 auto;
        width: 64px;
        height: 64px;
        border-radius: 14px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, rgba(14, 165, 233, 0.25), rgba(37, 99, 235, 0.25));
        color: #1e3a8a;
        font-weight: 600;
        font-size: 1rem;
        letter-spacing: 0.04em;
      }

      .product-vintage__thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .product-vintage__thumb--placeholder {
        background: linear-gradient(135deg, rgba(129, 140, 248, 0.18), rgba(14, 165, 233, 0.16));
      }

      .product-vintage__details {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
        min-width: 0;
      }

      .product-vintage__title {
        font-weight: 600;
        color: #0f172a;
        font-size: 0.95rem;
        line-height: 1.3;
        word-break: break-word;
      }

      .product-vintage__identifier {
        font-size: 0.8rem;
        color: #64748b;
        word-break: break-all;
      }

      .product-vintage__price {
        font-size: 0.85rem;
        color: #047857;
        font-weight: 600;
      }

      @media (max-width: 1080px) {
        .product-card__layout {
          grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        }

      }

      .product-media {
        position: relative;
        border-radius: 18px;
        overflow: hidden;
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.18), rgba(14, 165, 233, 0.12));
        min-height: 320px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1.25rem;
      }

      .product-media img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 14px;
      }

      .product-carousel {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .product-carousel[hidden] {
        display: none !important;
      }

      .product-carousel__viewport {
        width: 100%;
        height: 100%;
        overflow: hidden;
        border-radius: 14px;
      }

      .product-carousel__track {
        display: flex;
        height: 100%;
        transform: translateX(0);
        transition: transform 0.45s ease;
      }

      .product-carousel__track--no-transition {
        transition: none !important;
      }

      .product-carousel__slide {
        flex: 0 0 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .product-carousel__slide img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .product-carousel__nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: clamp(2.25rem, 5vw, 2.75rem);
        height: clamp(2.25rem, 5vw, 2.75rem);
        border-radius: 999px;
        border: none;
        background: rgba(15, 23, 42, 0.45);
        color: #ffffff;
        cursor: pointer;
        transition: background 0.2s ease, transform 0.2s ease;
        backdrop-filter: blur(8px);
      }

      .product-carousel__nav[hidden] {
        display: none !important;
      }

      .product-carousel__nav:hover,
      .product-carousel__nav:focus {
        background: rgba(15, 23, 42, 0.65);
        transform: translateY(-50%) scale(1.05);
        outline: none;
      }

      .product-carousel__nav:disabled {
        cursor: not-allowed;
        opacity: 0.65;
      }

      .product-carousel__nav--prev {
        left: clamp(0.5rem, 2vw, 1rem);
      }

      .product-carousel__nav--next {
        right: clamp(0.5rem, 2vw, 1rem);
      }

      .product-carousel__nav span {
        font-size: clamp(1.1rem, 3vw, 1.45rem);
        line-height: 1;
      }

      .product-carousel__indicators {
        position: absolute;
        bottom: clamp(0.65rem, 2vw, 1.1rem);
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 0.5rem;
        padding: 0.35rem 0.75rem;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.35);
        backdrop-filter: blur(10px);
      }

      .product-carousel__indicators[hidden] {
        display: none !important;
      }

      .product-carousel__indicator {
        width: 0.55rem;
        height: 0.55rem;
        border-radius: 999px;
        border: none;
        background: rgba(255, 255, 255, 0.55);
        padding: 0;
        cursor: pointer;
        transition: transform 0.2s ease, background 0.2s ease;
      }

      .product-carousel__indicator:hover,
      .product-carousel__indicator:focus {
        background: rgba(255, 255, 255, 0.85);
        transform: scale(1.1);
        outline: none;
      }

      .product-carousel__indicator[aria-current="true"] {
        background: #ffffff;
        transform: scale(1.15);
      }

      .product-media__placeholder {
        font-weight: 600;
        color: rgba(30, 64, 175, 0.75);
        text-align: center;
        line-height: 1.5;
        max-width: 26ch;
      }

      @media (prefers-reduced-motion: reduce) {
        .product-carousel__track {
          transition: none;
        }

        .product-carousel__indicator,
        .product-carousel__nav,
        .product-vintage__link,
        .edit-link {
          transition: none;
        }
      }

      @media (max-width: 720px) {
        main {
          width: min(100%, calc(100% - 1.5rem));
        }

        .header-actions {
          justify-content: flex-start;
        }

        .product-card__layout {
          grid-template-columns: minmax(0, 1fr);
        }

        .product-overview {
          order: -1;
        }

        .product-media {
          min-height: 240px;
        }

      }
    </style>
  </head>
  <body>
    <main>
      <header>
        <div class="header-actions">
          <a class="back-link" href="index.html" aria-label="Back to the product list">
            <span aria-hidden="true">&#8592;</span>
            Back to products
          </a>
          <a
            class="edit-link"
            id="edit-product-button"
            href="product_edit.html"
            aria-label="Edit this product"
            hidden
          >
            Edit product
          </a>
        </div>
      </header>

      <p id="status" role="status" aria-live="polite">Loading product details…</p>

      <article id="product-card" hidden>
        <div class="product-card__layout">
          <div class="product-overview">
            <section class="product-info" id="product-info" hidden>
              <h1 class="product-info__title" id="product-title" hidden></h1>
              <p class="product-info__description" id="product-description" hidden></p>
            </section>
            <section
              class="product-vintage"
              id="product-vintage-section"
              hidden
              aria-label="Related vintage products"
            >
              <h2 class="product-vintage__heading">Vintage products</h2>
              <p class="product-vintage__empty" id="product-vintage-empty" hidden></p>
              <ul class="product-vintage__list" id="product-vintage-list" hidden></ul>
            </section>
          </div>
          <div class="product-media" id="product-media">
            <div class="product-carousel" id="product-carousel" hidden>
              <button
                class="product-carousel__nav product-carousel__nav--prev"
                id="product-carousel-prev"
                type="button"
                aria-label="Show previous product image"
                hidden
              >
                <span aria-hidden="true">&#10094;</span>
              </button>
              <div class="product-carousel__viewport">
                <div class="product-carousel__track" id="product-carousel-track"></div>
              </div>
              <button
                class="product-carousel__nav product-carousel__nav--next"
                id="product-carousel-next"
                type="button"
                aria-label="Show next product image"
                hidden
              >
                <span aria-hidden="true">&#10095;</span>
              </button>
              <div
                class="product-carousel__indicators"
                id="product-carousel-indicators"
                role="tablist"
                hidden
              ></div>
            </div>
            <div class="product-media__placeholder" id="image-fallback">
              No product image available for this listing.
            </div>
          </div>

        </div>
      </article>
    </main>

    <script>
      const apiBaseUrl =
        "https://vintagecrawlerappservice-hqb0f5bmfrdwf0g7.polandcentral-01.azurewebsites.net/products";
      const monittaStoreEndpoint =
        "https://vintagecrawlerappservice-hqb0f5bmfrdwf0g7.polandcentral-01.azurewebsites.net/MonittaStore";
      const monittaStoreItems = [];
      const monittaStoreItemsById = new Map();
      let currentProductData = null;
      let currentProductTitle = "";
      if (typeof window !== "undefined") {
        window.monittaStoreItems = monittaStoreItems;
      }

      function toTrimmedString(value, fallback = "") {
        if (typeof value === "string") {
          const trimmed = value.trim();
          return trimmed || fallback;
        }

        if (value == null) {
          return fallback;
        }

        try {
          const trimmed = String(value).trim();
          return trimmed || fallback;
        } catch (error) {
          return fallback;
        }
      }

      function normalizeVintageProduct(entry) {
        if (!entry || typeof entry !== "object" || Array.isArray(entry)) {
          return null;
        }

        const normalized = { ...entry };
        normalized.VintageProductId = toTrimmedString(entry.VintageProductId);
        normalized.VintageProductName = toTrimmedString(entry.VintageProductName);
        normalized.VintageProductUrl = toTrimmedString(entry.VintageProductUrl);
        return normalized;
      }

      function normalizeProduct(rawProduct, fallbackId = "") {
        if (!rawProduct || typeof rawProduct !== "object") {
          return null;
        }

        const normalized = { ...rawProduct };
        const normalizedId = toTrimmedString(
          rawProduct.id ?? rawProduct.Id ?? rawProduct.ID,
          fallbackId,
        );
        normalized.id = normalizedId;
        normalized.Name = toTrimmedString(rawProduct.Name);
        normalized.Description = toTrimmedString(rawProduct.Description);

        const images = Array.isArray(rawProduct.Images) ? rawProduct.Images : [];
        const seenImages = new Set();
        normalized.Images = images
          .map((entry) => toTrimmedString(entry))
          .filter((entry) => {
            if (!entry || seenImages.has(entry)) {
              return false;
            }
            seenImages.add(entry);
            return true;
          });

        const vintageSource = Array.isArray(rawProduct.VintageProducts)
          ? rawProduct.VintageProducts
          : [];
        normalized.VintageProducts = vintageSource
          .map((entry) => normalizeVintageProduct(entry))
          .filter(Boolean);

        return normalized;
      }

      function extractMonittaStoreItems(payload, visited = new WeakSet()) {
        if (payload == null) {
          return [];
        }

        if (Array.isArray(payload)) {
          return payload;
        }

        if (typeof payload !== "object") {
          return [];
        }

        if (visited.has(payload)) {
          return [];
        }
        visited.add(payload);

        const candidateKeys = [
          "items",
          "products",
          "data",
          "results",
          "entries",
          "payload",
          "monittaStore",
          "monittaStoreItems",
          "value",
        ];

        for (const key of candidateKeys) {
          if (Array.isArray(payload[key])) {
            return payload[key];
          }
        }

        for (const key of candidateKeys) {
          const nested = payload[key];
          if (nested && typeof nested === "object") {
            const extracted = extractMonittaStoreItems(nested, visited);
            if (extracted.length) {
              return extracted;
            }
          }
        }

        for (const value of Object.values(payload)) {
          if (value && typeof value === "object") {
            const extracted = extractMonittaStoreItems(value, visited);
            if (extracted.length) {
              return extracted;
            }
          }
        }

        return [];
      }

      async function loadMonittaStoreItems() {
        try {
          const response = await fetch(monittaStoreEndpoint);
          if (!response.ok) {
            throw new Error(`Request failed with status ${response.status}`);
          }

          const payload = await response.json();
          const items = extractMonittaStoreItems(payload).filter(
            (item) => item != null,
          );

          monittaStoreItems.splice(0, monittaStoreItems.length, ...items);
          rebuildMonittaStoreIndex(monittaStoreItems);
        } catch (error) {
          console.error("Failed to load Monitta Store items.", error);
          monittaStoreItems.splice(0, monittaStoreItems.length);
          monittaStoreItemsById.clear();
        }

        if (currentProductData) {
          renderVintageProductsList(currentProductData);
        }

        return monittaStoreItems;
      }

      function buildProductImageUrl(value) {
        if (value == null) {
          return "";
        }

        if (value instanceof String) {
          return buildProductImageUrl(value.valueOf());
        }

        if (value instanceof URL) {
          return value.href;
        }

        if (Array.isArray(value)) {
          for (const candidate of value) {
            const resolved = buildProductImageUrl(candidate);
            if (resolved) {
              return resolved;
            }
          }
          return "";
        }

        if (value && typeof value === "object") {
          const candidateKeys = [
            "url",
            "URL",
            "href",
            "Href",
            "link",
            "Link",
            "src",
            "Src",
            "imageUrl",
            "ImageUrl",
            "imageURL",
            "ImageURL",
            "image",
            "Image",
            "imageSrc",
            "ImageSrc",
            "thumbnailUrl",
            "ThumbnailUrl",
            "thumbnailURL",
            "ThumbnailURL",
            "thumbnail",
            "Thumbnail",
            "picture",
            "Picture",
            "photo",
            "Photo",
            "photoUrl",
            "PhotoUrl",
            "photoURL",
            "PhotoURL",
            "path",
            "Path",
            "value",
            "Value",
          ];

          for (const key of candidateKeys) {
            if (key in value) {
              const resolved = buildProductImageUrl(value[key]);
              if (resolved) {
                return resolved;
              }
            }
          }

          return "";
        }

        let stringValue;
        if (typeof value === "string") {
          stringValue = value;
        } else {
          try {
            stringValue = String(value);
          } catch (error) {
            return "";
          }
        }
        const trimmedValue = stringValue.trim();
        if (!trimmedValue) {
          return "";
        }

        const sanitizedValue = trimmedValue.replace(/\\/g, "/");
        if (sanitizedValue.startsWith("//")) {
          return `https:${sanitizedValue}`;
        }

        return sanitizedValue;
      }

      function collectProductImageUrlsFromValue(value, addUrl, visited = new Set()) {
        if (value == null) {
          return;
        }

        if (value instanceof String) {
          collectProductImageUrlsFromValue(value.valueOf(), addUrl, visited);
          return;
        }

        if (value instanceof URL) {
          addUrl(value.href);
          return;
        }

        if (Array.isArray(value)) {
          for (const item of value) {
            collectProductImageUrlsFromValue(item, addUrl, visited);
          }
          return;
        }

        if (typeof value === "object") {
          if (visited.has(value)) {
            return;
          }

          visited.add(value);

          const candidateKeys = [
            "url",
            "href",
            "src",
            "imageUrl",
            "imageURL",
            "image",
            "imageSrc",
            "thumbnailUrl",
            "thumbnailURL",
            "thumbnail",
            "picture",
            "pictureUrl",
            "photo",
            "photoUrl",
            "path",
            "value",
            "full",
            "fullUrl",
            "fullURL",
            "fullsize",
            "fullSize",
            "large",
            "largeUrl",
            "largeURL",
            "largeImage",
            "medium",
            "mediumUrl",
            "mediumURL",
            "small",
            "smallUrl",
            "smallURL",
            "original",
            "originalUrl",
            "originalURL",
            "default",
            "defaultUrl",
            "defaultURL",
            "primary",
            "primaryUrl",
            "primaryURL",
            "preview",
            "previewUrl",
            "previewURL",
            "cover",
            "coverUrl",
            "coverURL",
          ];

          let matched = false;
          for (const key of candidateKeys) {
            if (key in value) {
              matched = true;
              collectProductImageUrlsFromValue(value[key], addUrl, visited);
            }
          }

          if (matched) {
            return;
          }

          if (Number.isInteger(value.length) && value.length > 0) {
            for (let index = 0; index < value.length; index += 1) {
              if (index in value) {
                collectProductImageUrlsFromValue(value[index], addUrl, visited);
              }
            }
            return;
          }

          for (const nested of Object.values(value)) {
            if (nested && typeof nested === "object") {
              collectProductImageUrlsFromValue(nested, addUrl, visited);
            }
          }

          return;
        }

        const resolved = buildProductImageUrl(value);
        if (resolved) {
          addUrl(resolved);
        }
      }

      function getProductImageUrls(product) {
        if (!product || typeof product !== "object") {
          return [];
        }

        const urls = [];
        const seen = new Set();
        const addUrl = (url) => {
          if (typeof url !== "string") {
            return;
          }

          const trimmed = url.trim();
          if (!trimmed || seen.has(trimmed)) {
            return;
          }

          seen.add(trimmed);
          urls.push(trimmed);
        };

        const imageEntries = Array.isArray(product.Images) ? product.Images : [];
        imageEntries.forEach((entry) => {
          collectProductImageUrlsFromValue(entry, addUrl);
        });

        return urls;
      }

      function normalizeIdentifier(value) {
        if (value == null) {
          return "";
        }

        if (typeof value === "string") {
          return value.trim();
        }

        if (typeof value === "number" || typeof value === "bigint") {
          return String(value);
        }

        if (typeof value === "boolean") {
          return value ? "true" : "false";
        }

        if (value instanceof Date) {
          return value.toISOString();
        }

        try {
          return String(value).trim();
        } catch (error) {
          return "";
        }
      }

      function normalizeText(value, visited = new WeakSet()) {
        if (value == null) {
          return "";
        }

        if (typeof value === "string") {
          return value.trim();
        }

        if (typeof value === "number" || typeof value === "bigint") {
          return String(value);
        }

        if (typeof value === "boolean") {
          return value ? "true" : "false";
        }

        if (value instanceof Date) {
          return value.toISOString();
        }

        if (Array.isArray(value)) {
          if (visited.has(value)) {
            return "";
          }
          visited.add(value);
          const parts = [];
          for (const entry of value) {
            const normalized = normalizeText(entry, visited);
            if (normalized) {
              parts.push(normalized);
            }
          }
          return parts.join(" ").trim();
        }

        if (typeof value === "object") {
          if (visited.has(value)) {
            return "";
          }
          visited.add(value);

          const candidateKeys = [
            "description",
            "text",
            "value",
            "content",
            "summary",
            "details",
            "body",
            "caption",
            "label",
          ];

          for (const key of candidateKeys) {
            if (key in value) {
              const normalized = normalizeText(value[key], visited);
              if (normalized) {
                return normalized;
              }
            }
          }

          for (const nested of Object.values(value)) {
            const normalized = normalizeText(nested, visited);
            if (normalized) {
              return normalized;
            }
          }
        }

        return "";
      }

      function gatherMonittaIdentifiers(item) {
        const identifiers = new Set();

        if (!item) {
          return identifiers;
        }

        if (typeof item !== "object" || Array.isArray(item)) {
          const normalized = normalizeIdentifier(item);
          if (normalized) {
            identifiers.add(normalized);
          }
          return identifiers;
        }

        const candidateKeys = [
          "VintageProductId",
          "vintageProductId",
          "id",
          "Id",
          "ID",
          "productId",
          "productID",
          "listingId",
          "listingID",
        ];

        for (const key of candidateKeys) {
          if (key in item) {
            const normalized = normalizeIdentifier(item[key]);
            if (normalized) {
              identifiers.add(normalized);
            }
          }
        }

        return identifiers;
      }

      function rebuildMonittaStoreIndex(items) {
        monittaStoreItemsById.clear();

        const array = Array.isArray(items) ? items : [];
        array.forEach((entry) => {
          gatherMonittaIdentifiers(entry).forEach((identifier) => {
            const key = identifier.toLowerCase();
            if (!monittaStoreItemsById.has(key)) {
              monittaStoreItemsById.set(key, entry);
            }
          });
        });
      }

      function getMonittaPrimaryPhoto(entry) {
        if (!entry || typeof entry !== "object") {
          return "";
        }

        if ("photo" in entry && entry.photo != null && entry.photo !== "") {
          const resolved = buildProductImageUrl(entry.photo);
          if (resolved) {
            return resolved;
          }
        }

        const fallbackKeys = [
          "photos",
          "images",
          "image",
          "imageUrl",
          "thumbnail",
          "thumbnailUrl",
          "picture",
          "media",
          "mediaUrls",
          "photoUrls",
          "thumbnails",
          "mediaItems",
        ];

        for (const key of fallbackKeys) {
          if (key in entry && entry[key] != null && entry[key] !== "") {
            const resolved = buildProductImageUrl(entry[key]);
            if (resolved) {
              return resolved;
            }
          }
        }

        return "";
      }

      function getVintageProductIdentifier(source) {
        if (source == null) {
          return "";
        }

        if (typeof source === "object" && !Array.isArray(source)) {
          const idCandidate = resolveField(
            source,
            [
              "VintageProductId",
              "vintageProductId",
              "id",
              "Id",
              "ID",
              "productId",
              "productID",
            ],
            "",
          );
          const normalizedId = normalizeIdentifier(idCandidate);
          if (normalizedId) {
            return normalizedId;
          }

          const urlCandidate = resolveField(
            source,
            [
              "VintageProductUrl",
              "vintageProductUrl",
              "url",
              "link",
              "productUrl",
              "href",
            ],
            "",
          );
          const normalizedUrl = normalizeIdentifier(urlCandidate);
          if (normalizedUrl) {
            return normalizedUrl;
          }

          const nameCandidate = resolveField(
            source,
            [
              "VintageProductName",
              "vintageProductName",
              "name",
              "title",
              "productName",
              "label",
            ],
            "",
          );
          return normalizeIdentifier(nameCandidate);
        }

        return normalizeIdentifier(source);
      }

      function findMonittaEntryForVintageProduct(entry) {
        if (!entry) {
          return null;
        }

        const identifiers = new Set();
        const directIdentifier = getVintageProductIdentifier(entry);
        if (directIdentifier) {
          identifiers.add(directIdentifier.toLowerCase());
        }

        if (entry && typeof entry === "object" && !Array.isArray(entry)) {
          gatherMonittaIdentifiers(entry).forEach((identifier) => {
            identifiers.add(identifier.toLowerCase());
          });
        }

        for (const key of identifiers) {
          if (monittaStoreItemsById.has(key)) {
            return monittaStoreItemsById.get(key);
          }
        }

        return null;
      }

      function extractVintageProducts(product) {
        if (!product || typeof product !== "object") {
          return [];
        }

        const source = Array.isArray(product.VintageProducts)
          ? product.VintageProducts
          : [];

        return source
          .map((entry) => normalizeVintageProduct(entry))
          .filter(Boolean);
      }

      function createVintageListItem(entry, index) {
        const fallbackTitle = `Vintage product ${index + 1}`;
        let title = fallbackTitle;
        let identifier = "";
        let url = "";
        let priceText = "";

        if (entry && typeof entry === "object" && !Array.isArray(entry)) {
          const resolvedTitle = resolveField(
            entry,
            [
              "VintageProductName",
              "vintageProductName",
              "name",
              "title",
              "productName",
              "label",
            ],
            fallbackTitle,
          );
          if (resolvedTitle != null && resolvedTitle !== "") {
            const trimmedTitle = String(resolvedTitle).trim();
            if (trimmedTitle) {
              title = trimmedTitle;
            }
          }

          const resolvedUrl = resolveField(
            entry,
            [
              "VintageProductUrl",
              "vintageProductUrl",
              "url",
              "link",
              "productUrl",
              "href",
            ],
            "",
          );
          if (resolvedUrl != null && resolvedUrl !== "") {
            const trimmedUrl = String(resolvedUrl).trim();
            if (trimmedUrl) {
              url = trimmedUrl;
            }
          }

          identifier = getVintageProductIdentifier(entry);

          const priceValue = resolveField(
            entry,
            [
              "priceFormatted",
              "price",
              "priceValue",
              "amount",
              "currentPrice",
              "value",
            ],
            "",
          );
          const currencyValue = resolveField(
            entry,
            [
              "currency",
              "priceCurrency",
              "currencyCode",
              "currencySymbol",
            ],
            "",
          );
          const formattedPrice = formatPrice(priceValue, currencyValue);
          if (formattedPrice) {
            priceText = formattedPrice;
          } else if (priceValue != null && priceValue !== "") {
            const fallbackPrice = String(priceValue).trim();
            if (fallbackPrice) {
              priceText = fallbackPrice;
            }
          }
        } else if (entry != null && entry !== "") {
          const textValue = String(entry).trim();
          if (textValue) {
            title = textValue;
            identifier = textValue;
          }
        }

        const monittaEntry = findMonittaEntryForVintageProduct(entry);
        let imageUrl = monittaEntry ? getMonittaPrimaryPhoto(monittaEntry) : "";

        if (!imageUrl && entry && typeof entry === "object" && !Array.isArray(entry)) {
          const fallbackImage = resolveField(
            entry,
            [
              "photo",
              "photos",
              "image",
              "imageUrl",
              "thumbnail",
              "thumbnailUrl",
              "picture",
            ],
            "",
          );
          if (fallbackImage) {
            imageUrl = buildProductImageUrl(fallbackImage);
          }
        }

        const listItem = document.createElement("li");
        listItem.className = "product-vintage__item";

        const wrapper = document.createElement(url ? "a" : "div");
        wrapper.className = "product-vintage__link";
        if (url) {
          wrapper.href = url;
          wrapper.target = "_blank";
          wrapper.rel = "noopener";
        }

        const thumb = document.createElement("div");
        thumb.className = "product-vintage__thumb";

        if (imageUrl) {
          const image = document.createElement("img");
          image.src = imageUrl;
          image.alt = title ? `${title} – vintage product preview` : "Vintage product preview";
          image.loading = "lazy";
          image.decoding = "async";
          thumb.appendChild(image);
        } else {
          thumb.classList.add("product-vintage__thumb--placeholder");
          const fallbackCharacter = title ? title.charAt(0).toUpperCase() : "•";
          thumb.textContent = fallbackCharacter || "•";
        }

        const details = document.createElement("div");
        details.className = "product-vintage__details";

        const nameElement = document.createElement("span");
        nameElement.className = "product-vintage__title";
        nameElement.textContent = title;
        details.appendChild(nameElement);

        const normalizedIdentifier = normalizeIdentifier(identifier);
        if (normalizedIdentifier) {
          const idElement = document.createElement("span");
          idElement.className = "product-vintage__identifier";
          idElement.textContent = `ID: ${normalizedIdentifier}`;
          details.appendChild(idElement);
        }

        if (priceText) {
          const priceElement = document.createElement("span");
          priceElement.className = "product-vintage__price";
          priceElement.textContent = priceText;
          details.appendChild(priceElement);
        }

        wrapper.append(thumb, details);
        listItem.appendChild(wrapper);

        return {
          element: listItem,
          identifier: normalizedIdentifier,
        };
      }

      function renderVintageProductsList(product) {
        if (!vintageSection || !vintageListElement || !vintageEmptyElement) {
          return;
        }

        if (!product || typeof product !== "object") {
          vintageSection.hidden = true;
          vintageListElement.innerHTML = "";
          vintageListElement.hidden = true;
          vintageEmptyElement.hidden = true;
          return;
        }

        const entries = extractVintageProducts(product);
        vintageListElement.innerHTML = "";
        const seen = new Set();
        let renderedCount = 0;

        entries.forEach((entry, index) => {
          const listItem = createVintageListItem(entry, index);
          if (!listItem) {
            return;
          }

          const key = listItem.identifier
            ? listItem.identifier.toLowerCase()
            : `__index-${index}`;
          if (seen.has(key)) {
            return;
          }
          seen.add(key);
          vintageListElement.appendChild(listItem.element);
          renderedCount += 1;
        });

        if (renderedCount > 0) {
          vintageSection.hidden = false;
          vintageListElement.hidden = false;
          vintageEmptyElement.hidden = true;
        } else {
          const trimmedTitle =
            typeof currentProductTitle === "string" ? currentProductTitle.trim() : "";
          const listingName = trimmedTitle
            ? `“${trimmedTitle}”`
            : "this listing";
          vintageEmptyElement.textContent = `No vintage products are linked to ${listingName}.`;
          vintageSection.hidden = false;
          vintageListElement.hidden = true;
          vintageEmptyElement.hidden = false;
        }
      }

      const editProductLink = document.getElementById("edit-product-button");
      const defaultEditProductLabel = "Edit this product";
      const statusElement = document.getElementById("status");
      const productCard = document.getElementById("product-card");
      const productInfoSection = document.getElementById("product-info");
      const productTitleElement = document.getElementById("product-title");
      const productDescriptionElement = document.getElementById("product-description");
      const vintageSection = document.getElementById("product-vintage-section");
      const vintageListElement = document.getElementById("product-vintage-list");
      const vintageEmptyElement = document.getElementById("product-vintage-empty");
      const imageFallback = document.getElementById("image-fallback");
      const productCarousel = document.getElementById("product-carousel");
      const carouselTrack = document.getElementById("product-carousel-track");
      const carouselIndicators = document.getElementById("product-carousel-indicators");
      const carouselPrevButton = document.getElementById("product-carousel-prev");
      const carouselNextButton = document.getElementById("product-carousel-next");

      let carouselImages = [];
      let carouselCurrentIndex = 0;
      let carouselTitle = "";

      function renderProductCarousel(imageUrls, title) {
        carouselImages = Array.isArray(imageUrls) ? imageUrls.slice() : [];
        carouselTitle = typeof title === "string" ? title.trim() : "";
        carouselCurrentIndex = 0;

        if (carouselTrack) {
          carouselTrack.innerHTML = "";
          carouselTrack.style.transform = "translateX(0)";
          carouselTrack.classList.remove("product-carousel__track--no-transition");
        }

        if (carouselIndicators) {
          carouselIndicators.innerHTML = "";
        }

        if (!carouselImages.length) {
          if (productCarousel) {
            productCarousel.hidden = true;
          }
          if (imageFallback) {
            imageFallback.hidden = false;
          }
          if (carouselPrevButton) {
            carouselPrevButton.hidden = true;
            carouselPrevButton.disabled = true;
          }
          if (carouselNextButton) {
            carouselNextButton.hidden = true;
            carouselNextButton.disabled = true;
          }
          if (carouselIndicators) {
            carouselIndicators.hidden = true;
          }
          return;
        }

        const total = carouselImages.length;
        const effectiveTitle = carouselTitle || "Product";

        if (carouselTrack) {
          carouselImages.forEach((url, index) => {
            const slide = document.createElement("div");
            slide.className = "product-carousel__slide";
            slide.setAttribute("role", "group");
            slide.setAttribute("aria-roledescription", "slide");
            slide.setAttribute("aria-label", `Image ${index + 1} of ${total}`);

            const image = document.createElement("img");
            image.src = url;
            image.alt =
              total > 1
                ? `${effectiveTitle} – image ${index + 1} of ${total}`
                : `${effectiveTitle} image`;
            image.loading = index === 0 ? "eager" : "lazy";
            image.decoding = "async";

            slide.appendChild(image);
            carouselTrack.appendChild(slide);

            if (carouselIndicators && total > 1) {
              const indicator = document.createElement("button");
              indicator.type = "button";
              indicator.className = "product-carousel__indicator";
              indicator.dataset.index = String(index);
              indicator.setAttribute("aria-label", `Show image ${index + 1}`);
              indicator.setAttribute("role", "tab");
              indicator.setAttribute("aria-selected", index === 0 ? "true" : "false");
              indicator.tabIndex = index === 0 ? 0 : -1;
              carouselIndicators.appendChild(indicator);
            }
          });
        }

        if (productCarousel) {
          productCarousel.hidden = false;
        }
        if (imageFallback) {
          imageFallback.hidden = true;
        }

        const showNavigation = total > 1;
        if (carouselPrevButton) {
          carouselPrevButton.hidden = !showNavigation;
          carouselPrevButton.disabled = !showNavigation;
        }
        if (carouselNextButton) {
          carouselNextButton.hidden = !showNavigation;
          carouselNextButton.disabled = !showNavigation;
        }
        if (carouselIndicators) {
          carouselIndicators.hidden = !showNavigation;
        }

        goToCarouselIndex(0, { animate: false });
      }

      function goToCarouselIndex(
        index,
        { animate = true, focusIndicator = false } = {},
      ) {
        if (!carouselImages.length || !carouselTrack) {
          return;
        }

        const total = carouselImages.length;
        const normalizedIndex = ((index % total) + total) % total;
        carouselCurrentIndex = normalizedIndex;

        if (!animate) {
          carouselTrack.classList.add("product-carousel__track--no-transition");
        }

        carouselTrack.style.transform = `translateX(-${normalizedIndex * 100}%)`;

        const slides = Array.from(carouselTrack.children);
        slides.forEach((slide, slideIndex) => {
          const isActive = slideIndex === normalizedIndex;
          slide.setAttribute("aria-hidden", isActive ? "false" : "true");
        });

        if (carouselIndicators) {
          const indicators = Array.from(
            carouselIndicators.querySelectorAll(".product-carousel__indicator"),
          );

          indicators.forEach((indicator, indicatorIndex) => {
            const isActive = indicatorIndex === normalizedIndex;
            indicator.setAttribute("aria-current", isActive ? "true" : "false");
            indicator.setAttribute("aria-selected", isActive ? "true" : "false");
            indicator.tabIndex = isActive ? 0 : -1;
          });

          if (focusIndicator) {
            const activeIndicator = indicators[normalizedIndex];
            if (activeIndicator) {
              activeIndicator.focus();
            }
          }
        }

        if (carouselPrevButton) {
          carouselPrevButton.disabled = total <= 1;
        }
        if (carouselNextButton) {
          carouselNextButton.disabled = total <= 1;
        }

        if (!animate) {
          requestAnimationFrame(() => {
            if (carouselTrack) {
              carouselTrack.classList.remove("product-carousel__track--no-transition");
            }
          });
        }
      }

      if (carouselPrevButton) {
        carouselPrevButton.addEventListener("click", () => {
          if (!carouselImages.length) {
            return;
          }
          goToCarouselIndex(carouselCurrentIndex - 1);
        });
      }

      if (carouselNextButton) {
        carouselNextButton.addEventListener("click", () => {
          if (!carouselImages.length) {
            return;
          }
          goToCarouselIndex(carouselCurrentIndex + 1);
        });
      }

      if (carouselIndicators) {
        carouselIndicators.addEventListener("click", (event) => {
          const target =
            event.target instanceof Element ? event.target.closest("button") : null;
          if (!target || !target.dataset.index) {
            return;
          }

          const parsed = Number.parseInt(target.dataset.index, 10);
          if (Number.isInteger(parsed)) {
            goToCarouselIndex(parsed);
          }
        });

        carouselIndicators.addEventListener("keydown", (event) => {
          if (!carouselImages.length) {
            return;
          }

          switch (event.key) {
            case "ArrowLeft":
            case "ArrowRight": {
              event.preventDefault();
              const delta = event.key === "ArrowLeft" ? -1 : 1;
              goToCarouselIndex(carouselCurrentIndex + delta, { focusIndicator: true });
              break;
            }
            case "Home":
              event.preventDefault();
              goToCarouselIndex(0, { focusIndicator: true });
              break;
            case "End":
              event.preventDefault();
              goToCarouselIndex(carouselImages.length - 1, { focusIndicator: true });
              break;
            default:
              break;
          }
        });
      }

      function renderProductSummary(product) {
        if (!productInfoSection || !productTitleElement || !productDescriptionElement) {
          return;
        }

        const hasProduct = product && typeof product === "object";
        const titleText = hasProduct ? toTrimmedString(product.Name) : "";
        const descriptionText = hasProduct
          ? toTrimmedString(product.Description)
          : "";
        const hasTitle = Boolean(titleText);
        const hasDescription = Boolean(descriptionText);

        if (!hasTitle && !hasDescription) {
          productInfoSection.hidden = true;
          productTitleElement.textContent = "";
          productTitleElement.hidden = true;
          productDescriptionElement.textContent = "";
          productDescriptionElement.hidden = true;
          productDescriptionElement.classList.remove("product-info__description--empty");
          return;
        }

        if (hasTitle) {
          productTitleElement.textContent = titleText;
          productTitleElement.hidden = false;
        } else {
          productTitleElement.textContent = "";
          productTitleElement.hidden = true;
        }

        if (hasDescription) {
          productDescriptionElement.textContent = descriptionText;
          productDescriptionElement.hidden = false;
          productDescriptionElement.classList.remove("product-info__description--empty");
        } else {
          productDescriptionElement.textContent = "No description is available for this listing.";
          productDescriptionElement.hidden = false;
          productDescriptionElement.classList.add("product-info__description--empty");
        }

        productInfoSection.hidden = false;
      }

      function getProductIdFromQuery() {
        const params = new URLSearchParams(window.location.search);
        const keys = ["productID", "productId", "id"];
        for (const key of keys) {
          const value = params.get(key);
          if (typeof value === "string" && value.trim()) {
            return value.trim();
          }
        }
        return "";
      }

      function updateEditProductLink(productId, title = "") {
        if (!editProductLink) {
          return;
        }

        const trimmedId = typeof productId === "string" ? productId.trim() : "";
        const trimmedTitle = typeof title === "string" ? title.trim() : "";

        if (trimmedId) {
          editProductLink.href = `product_edit.html?productID=${encodeURIComponent(trimmedId)}`;
          editProductLink.hidden = false;
          if (trimmedTitle) {
            editProductLink.setAttribute(
              "aria-label",
              `Edit product “${trimmedTitle}”`,
            );
          } else {
            editProductLink.setAttribute("aria-label", defaultEditProductLabel);
          }
        } else {
          editProductLink.hidden = true;
          editProductLink.removeAttribute("href");
          editProductLink.setAttribute("aria-label", defaultEditProductLabel);
        }
      }

      function resolveField(object, candidates, fallback = "") {
        if (!object || typeof object !== "object") {
          return fallback;
        }

        for (const key of candidates) {
          if (key in object && object[key] != null && object[key] !== "") {
            return object[key];
          }
        }

        return fallback;
      }

      function formatPrice(value, currency) {
        if (value == null || value === "") {
          return "";
        }

        if (typeof value === "string") {
          const trimmed = value.trim();
          if (trimmed) {
            return trimmed;
          }
        }

        const numeric = Number(value);
        if (Number.isFinite(numeric)) {
          if (typeof currency === "string" && currency.trim()) {
            try {
              return new Intl.NumberFormat(undefined, {
                style: "currency",
                currency: currency.trim().toUpperCase(),
              }).format(numeric);
            } catch (error) {
              return `${numeric.toFixed(2)} ${currency}`;
            }
          }

          return numeric.toLocaleString(undefined, {
            minimumFractionDigits: 0,
            maximumFractionDigits: 2,
          });
        }

        return "";
      }

      function extractProduct(payload) {
        if (!payload) {
          return null;
        }

        if (Array.isArray(payload)) {
          return payload[0] ?? null;
        }

        if (typeof payload === "object") {
          const candidateKeys = ["product", "data", "item", "result", "payload"];
          for (const key of candidateKeys) {
            if (payload[key] && typeof payload[key] === "object") {
              return payload[key];
            }
          }
        }

        if (typeof payload === "object") {
          return payload;
        }

        return null;
      }

      async function loadProduct() {
        const productId = getProductIdFromQuery();
        updateEditProductLink(productId);
        currentProductData = null;
        currentProductTitle = "";
        renderProductSummary(null);
        renderVintageProductsList(null);

        if (!productId) {
          statusElement.textContent =
            "Missing productID parameter. Append ?productID=<id> to the page URL.";
          productCard.hidden = true;
          return;
        }

        statusElement.hidden = false;
        statusElement.textContent = "Loading product details…";
        productCard.hidden = true;

        const url = `${apiBaseUrl}/${encodeURIComponent(productId)}`;

        try {
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error(`Request failed with status ${response.status}`);
          }

          const payload = await response.json();
          const extracted = extractProduct(payload);
          const product = normalizeProduct(extracted, productId);

          if (!product || typeof product !== "object") {
            currentProductData = null;
            currentProductTitle = "";
            renderProductSummary(null);
            renderVintageProductsList(null);
            statusElement.textContent = "No product details were returned for this identifier.";
            productCard.hidden = true;
            return;
          }

          const title = product.Name || `Product ${productId}`;
          document.title = `${title} – Monitta Store`;

          currentProductTitle = title;
          currentProductData = product;
          updateEditProductLink(productId, title);
          renderProductSummary(product);
          renderVintageProductsList(product);

          const imageUrls = getProductImageUrls(product);
          renderProductCarousel(imageUrls, title);

          statusElement.textContent = "";
          statusElement.hidden = true;
          productCard.hidden = false;
        } catch (error) {
          console.error(error);
          currentProductData = null;
          currentProductTitle = "";
          renderProductSummary(null);
          renderVintageProductsList(null);
          statusElement.hidden = false;
          statusElement.textContent =
            "We could not load product information. Please verify the product ID and try again.";
          productCard.hidden = true;
        }
      }

      const monittaStoreItemsPromise = loadMonittaStoreItems();
      if (typeof window !== "undefined") {
        window.monittaStoreItemsPromise = monittaStoreItemsPromise;
      }

      loadProduct();
    </script>
  </body>
</html>
